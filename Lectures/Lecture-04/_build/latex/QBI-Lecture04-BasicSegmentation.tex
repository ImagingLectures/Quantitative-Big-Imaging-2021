%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}



\usepackage{times}
\expandafter\ifx\csname T@LGR\endcsname\relax
\else
% LGR was declared as font encoding
  \substitutefont{LGR}{\rmdefault}{cmr}
  \substitutefont{LGR}{\sfdefault}{cmss}
  \substitutefont{LGR}{\ttdefault}{cmtt}
\fi
\expandafter\ifx\csname T@X2\endcsname\relax
  \expandafter\ifx\csname T@T2A\endcsname\relax
  \else
  % T2A was declared as font encoding
    \substitutefont{T2A}{\rmdefault}{cmr}
    \substitutefont{T2A}{\sfdefault}{cmss}
    \substitutefont{T2A}{\ttdefault}{cmtt}
  \fi
\else
% X2 was declared as font encoding
  \substitutefont{X2}{\rmdefault}{cmr}
  \substitutefont{X2}{\sfdefault}{cmss}
  \substitutefont{X2}{\ttdefault}{cmtt}
\fi


\usepackage[Bjarne]{fncychap}
\usepackage[,numfigreset=1,mathnumfig]{sphinx}

\fvset{fontsize=\small}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}


\usepackage{sphinxmessages}




\title{Quantitative Big Imaging - Basic segmentation}
\date{Mar 18, 2021}
\release{}
\author{Anders Kaestner}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{}
\makeindex
\begin{document}

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{04-BasicSegmentation::doc}}




\sphinxAtStartPar
\sphinxstylestrong{Quantitative Big Imaging} ETHZ: 227\sphinxhyphen{}0966\sphinxhyphen{}00L

\sphinxAtStartPar
\sphinxstylestrong{Part 1}: Image formation and thresholding






\chapter{Today’s lecture}
\label{\detokenize{04-BasicSegmentation:today-s-lecture}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Motivation

\item {} 
\sphinxAtStartPar
Qualitative Approaches

\item {} 
\sphinxAtStartPar
Image formation and interpretation problems

\item {} 
\sphinxAtStartPar
Thresholding

\item {} 
\sphinxAtStartPar
Other types of images

\item {} 
\sphinxAtStartPar
Selecting a good threshold

\item {} 
\sphinxAtStartPar
Implementation

\item {} 
\sphinxAtStartPar
Morphology

\item {} 
\sphinxAtStartPar
Partial volume effects

\end{itemize}


\chapter{Load some modules}
\label{\detokenize{04-BasicSegmentation:load-some-modules}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io}          \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color}       \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology}  \PYG{k+kn}{import} \PYG{n}{disk}
\PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{ndimage}       \PYG{k+kn}{import} \PYG{n}{zoom}
\PYG{k+kn}{import} \PYG{n+nn}{numpy}             \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology} \PYG{k+kn}{import} \PYG{n}{ball}
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline

\PYG{c+c1}{\PYGZsh{} For the 3D rendering}
\PYG{k+kn}{import} \PYG{n+nn}{plotly}\PYG{n+nn}{.}\PYG{n+nn}{offline} \PYG{k}{as} \PYG{n+nn}{py}
\PYG{k+kn}{from} \PYG{n+nn}{plotly}\PYG{n+nn}{.}\PYG{n+nn}{figure\PYGZus{}factory} \PYG{k+kn}{import} \PYG{n}{create\PYGZus{}trisurf}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{measure} \PYG{k+kn}{import} \PYG{n}{marching\PYGZus{}cubes}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{g+gt}{\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n+ne}{ModuleNotFoundError}\PYG{g+gWhitespace}{                       }Traceback (most recent call last)
\PYG{o}{\PYGZlt{}}\PYG{n}{ipython}\PYG{o}{\PYGZhy{}}\PYG{n+nb}{input}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{77}\PYG{n}{d8d2007e2e}\PYG{o}{\PYGZgt{}} \PYG{o+ow}{in} \PYG{o}{\PYGZlt{}}\PYG{n}{module}\PYG{o}{\PYGZgt{}}
\PYG{n+ne}{\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZgt{} }\PYG{l+m+mi}{1} \PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io}          \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{2} \PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color}       \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{3} \PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{4} \PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology}  \PYG{k+kn}{import} \PYG{n}{disk}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{5} \PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{ndimage}       \PYG{k+kn}{import} \PYG{n}{zoom}

\PYG{n+ne}{ModuleNotFoundError}: No module named \PYGZsq{}skimage\PYGZsq{}
\end{sphinxVerbatim}


\chapter{Applications}
\label{\detokenize{04-BasicSegmentation:applications}}
\sphinxAtStartPar
In this lecture we are going to focus on basic segmentation approaches that work well for simple two\sphinxhyphen{}phase materials. Segmenting complex samples like
\begin{itemize}
\item {} 
\sphinxAtStartPar
Beyond 1 channel of depth

\item {} 
\sphinxAtStartPar
Multiple phase materials

\item {} 
\sphinxAtStartPar
Filling holes in materials

\item {} 
\sphinxAtStartPar
Segmenting Fossils

\item {} 
\sphinxAtStartPar
Attempting to segment the cortex in brain imaging (see figure below)

\end{itemize}

\sphinxAtStartPar
can be a very challenging task. Such tasks will be covered in later lectures.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[scale=0.5]{{cortex}.png}
\caption{An x\sphinxhyphen{}ray CT slice of the cortex.}\label{\detokenize{04-BasicSegmentation:id2}}\end{figure}


\begin{itemize}
\item {} 
\sphinxAtStartPar
Simple two\sphinxhyphen{}phase materials (bone, cells, etc)

\item {} 
\sphinxAtStartPar
Beyond 1 channel of depth
\begin{itemize}
\item {} 
\sphinxAtStartPar
Multiple phase materials

\item {} 
\sphinxAtStartPar
Filling holes in materials

\item {} 
\sphinxAtStartPar
Segmenting Fossils

\item {} 
\sphinxAtStartPar
Attempting to segment the cortex in brain imaging

\end{itemize}

\end{itemize}




\chapter{Literature / Useful References}
\label{\detokenize{04-BasicSegmentation:literature-useful-references}}\begin{itemize}
\item {} 
\sphinxAtStartPar
John C. Russ, “The Image Processing Handbook”,(Boca Raton, CRC Press)

\item {} 
\sphinxAtStartPar
Available \sphinxhref{http://dx.doi.org/10.1201/9780203881095}{online} within domain \sphinxhref{http://ethz.ch}{ethz.ch} (or \sphinxhref{http://proxy.ethz.ch}{proxy.ethz.ch} / public VPN)

\end{itemize}


\section{Models / ROC Curves}
\label{\detokenize{04-BasicSegmentation:models-roc-curves}}\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://www.youtube.com/watch?v=ryZL4XNUmwo}{Julia Evans \sphinxhyphen{} Recalling with Precision}

\item {} 
\sphinxAtStartPar
\sphinxhref{https://github.com/stripe/topmodel}{Stripe’s Next Top Model}

\end{itemize}


\chapter{Motivation:  Why do we do imaging experiments?}
\label{\detokenize{04-BasicSegmentation:motivation-why-do-we-do-imaging-experiments}}
\sphinxAtStartPar
There are different reasons for performing an image experiment. This often depends on in which state you are in your project.


\section{Exploratory}
\label{\detokenize{04-BasicSegmentation:exploratory}}
\sphinxAtStartPar
In the initial phase, you want to learn what your sample looks like with the chosen modality. Maybe, you don’t even know what is in there to see. The explorative type of experiment mostly only allows qualitative conclusions. These conclusions will however help you to formulate better hypotheses for more detailed experiments.
\begin{itemize}
\item {} 
\sphinxAtStartPar
To visually, qualitatively examine samples and differences between them

\item {} 
\sphinxAtStartPar
No prior knowledge or expectations

\end{itemize}


\section{To test a hypothesis}
\label{\detokenize{04-BasicSegmentation:to-test-a-hypothesis}}
\sphinxAtStartPar
When you perform an experiment to test a hypothesis, you already know relatively much about your sample and want make an investigation where you can quantify characteristic features.

\sphinxAtStartPar
Quantitative assessment coupled with statistical analysis
\begin{itemize}
\item {} 
\sphinxAtStartPar
Does temperature affect bubble size?

\item {} 
\sphinxAtStartPar
Is this gene important for cell shape and thus mechanosensation in bone?

\item {} 
\sphinxAtStartPar
Does higher canal volume make bones weaker?

\item {} 
\sphinxAtStartPar
Does the granule shape affect battery life expectancy?

\end{itemize}


\section{What we are looking at?}
\label{\detokenize{04-BasicSegmentation:what-we-are-looking-at}}



\section{To test a hypothesis}
\label{\detokenize{04-BasicSegmentation:id1}}
\sphinxAtStartPar
We perform an experiment bone to see how big the cells are inside the tissue:

\sphinxAtStartPar
We have performed an experiment that produced heaps of data to analyze. For example a using tomography.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[scale=1.0]{{tomoimage}.png}
\caption{Acquisition workflow to obtain CT slices of a specimen.}\label{\detokenize{04-BasicSegmentation:id3}}\end{figure}

\sphinxAtStartPar
At the beginning we have 2560 x 2560 x 2160 x 32 bits = 56GB / sample! Then we apply some filtering and preprocessing to prepare the data for analysis. After 20h of computer time we still have 56GB of data (it is however nicer to work with). This still way to much data to handle, we need to reduce it in some way.




\begin{equation*}
\begin{split}\downarrow\end{split}
\end{equation*}






\sphinxAtStartPar
\sphinxstylestrong{Way too much data, we need to reduce}




\section{What did we want in the first place?}
\label{\detokenize{04-BasicSegmentation:what-did-we-want-in-the-first-place}}

\subsection{\sphinxstyleemphasis{Single numbers}:}
\label{\detokenize{04-BasicSegmentation:single-numbers}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Volume \sphinxstyleemphasis{fraction},

\item {} 
\sphinxAtStartPar
Cell \sphinxstyleemphasis{count},

\item {} 
\sphinxAtStartPar
Average cell \sphinxstyleemphasis{stretch},

\item {} 
\sphinxAtStartPar
Cell volume \sphinxstyleemphasis{variability}

\end{itemize}

\sphinxAtStartPar
These are all \sphinxstylestrong{measurable} metrics!


\section{Why do we perform segmentation?}
\label{\detokenize{04-BasicSegmentation:why-do-we-perform-segmentation}}
\sphinxAtStartPar
In model\sphinxhyphen{}based analysis every step we peform, simple or complicated is related to an underlying model of the system we are dealing with
\begin{itemize}
\item {} 
\sphinxAtStartPar
Identify relevant regions in the images

\item {} 
\sphinxAtStartPar
Many methods are available to solve the segmentation task.

\item {} 
\sphinxAtStartPar
Choose wisely… \sphinxhref{http://en.wikipedia.org/wiki/Occams\_Razor}{\sphinxstyleemphasis{Occam’s Razor}} is very important here : \sphinxstylestrong{The simplest solution is usually the right one}

\end{itemize}

\sphinxAtStartPar
Advanced methods like a Bayesian, neural networks optimized using genetic algorithms with Fuzzy logic has a much larger parameter space to explore, establish sensitivity in, and must perform much better and be tested much more thoroughly than thresholding to be justified.

\sphinxAtStartPar
The next two lectures will cover powerful segmentation techinques, in particular with unknown data.


\section{Review: Filtering and Image Enhancement}
\label{\detokenize{04-BasicSegmentation:review-filtering-and-image-enhancement}}
\sphinxAtStartPar
This was a noise process which was added to otherwise clean imaging data


\begin{equation*}
\begin{split} I_{measured}(x,y) = I_{sample}(x,y) + \text{Noise}(x,y) \end{split}
\end{equation*}\begin{itemize}
\item {} 
\sphinxAtStartPar
What would the perfect filter be

\end{itemize}
\begin{equation*}
\begin{split} \textit{Filter} \ast I_{sample}(x,y) = I_{sample}(x,y) \end{split}
\end{equation*}




\sphinxAtStartPar
What \sphinxstylestrong{most filters} end up doing
\$\( \textit{Filter} \ast I_{measured}(x,y) = 90\%  I_{real}(x,y) + 10\% \text{Noise}(x,y) \)\$





\sphinxAtStartPar
What \sphinxstylestrong{bad filters} do
\$\( \textit{Filter} \ast I_{measured}(x,y) = 10\% I_{real}(x,y) + 90\% \text{Noise}(x,y) \)\$




\section{What we get from the imaging modality}
\label{\detokenize{04-BasicSegmentation:what-we-get-from-the-imaging-modality}}
\sphinxAtStartPar
To demonstrate what we get from a modality, we load the cell image as a toy example.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{dkimg} \PYG{o}{=} \PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{figures/Average\PYGZus{}prokaryote\PYGZus{}cell.jpg}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{rgb2gray}\PYG{p}{(}\PYG{n}{dkimg}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_30_0}.png}


\chapter{Qualitative Metrics: What did people use to do?}
\label{\detokenize{04-BasicSegmentation:qualitative-metrics-what-did-people-use-to-do}}
\sphinxAtStartPar
What comes out of our detector / enhancement process

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{dkimg} \PYG{o}{=} \PYG{n}{rgb2gray}\PYG{p}{(}\PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{figures/Average\PYGZus{}prokaryote\PYGZus{}cell.jpg}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}img}\PYG{p}{,} \PYG{n}{ax\PYGZus{}hist}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{m\PYGZus{}show\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ax\PYGZus{}img}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{dkimg}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{cb\PYGZus{}obj} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{m\PYGZus{}show\PYGZus{}obj}\PYG{p}{,}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax\PYGZus{}img}\PYG{p}{,}\PYG{n}{shrink}\PYG{o}{=}\PYG{l+m+mf}{0.8}\PYG{p}{)}
\PYG{n}{cb\PYGZus{}obj}\PYG{o}{.}\PYG{n}{set\PYGZus{}label}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Absorption Coefficient}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax\PYGZus{}img}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Measured image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{dkimg}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Absorption Coefficient}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gray level histogram}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_33_0}.png}


\section{Identify objects by eye}
\label{\detokenize{04-BasicSegmentation:identify-objects-by-eye}}
\sphinxAtStartPar
The first qualitative analysis is mostly done by eye. You look at the image to describe what you see. This first assessment will help you decide how to approach the quantitative analysis task. Here, it is important to think about using words that can be translated into an image processing workflow.
\begin{itemize}
\item {} 
\sphinxAtStartPar
Count,

\item {} 
\sphinxAtStartPar
Describe qualitatively: “many little cilia on surface”, “long curly flaggelum”, “elongated nuclear structure”

\end{itemize}


\section{Morphometrics}
\label{\detokenize{04-BasicSegmentation:morphometrics}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Trace the outline of the object (or sub\sphinxhyphen{}structures)

\item {} 
\sphinxAtStartPar
Employing the “\sphinxhref{http://ion.chem.usu.edu/~sbialkow/Classes/361/GC/GC.html}{cut\sphinxhyphen{}and\sphinxhyphen{}weigh}” method

\end{itemize}


\chapter{Segmentation Approaches}
\label{\detokenize{04-BasicSegmentation:segmentation-approaches}}
\sphinxAtStartPar
In the introduction lecture we talked about how people approach an image analysis problem depending on their background. This is something that becomes very clear when an image is about to be segmented.

\sphinxAtStartPar
They match up well to the world view / perspective




\section{How to approach the segmentation task}
\label{\detokenize{04-BasicSegmentation:how-to-approach-the-segmentation-task}}

\subsection{Model based segmentation}
\label{\detokenize{04-BasicSegmentation:model-based-segmentation}}
\sphinxAtStartPar
The experimentalists approached the segmenation task based on their experience and knowledge about the samples. This results in a top\sphinxhyphen{}down approach and quite commonly based on models fitting the real world, what we actually can see in the images. The analysis aims at solving the problems needed to provide answers to the defined hypothesis.


\subsection{Algorithmic segmentation approach}
\label{\detokenize{04-BasicSegmentation:algorithmic-segmentation-approach}}
\sphinxAtStartPar
The opposite approach is to find and use generalized algorithms that provides the results. This approach is driven by the results as the computer vision and deep learning experts often don’t have the knowledge to interpret the data.




\section{Model\sphinxhyphen{}based Analysis}
\label{\detokenize{04-BasicSegmentation:model-based-analysis}}
\sphinxAtStartPar
The image formation process is the process to use some kind of excitation or impulse probe a sample. This requires the interaction of the four parts in the figure below.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[scale=0.8]{{image-formation}.pdf}
\caption{The elements of the image formation process.}\label{\detokenize{04-BasicSegmentation:id4}}\end{figure}
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Impulses} Light, X\sphinxhyphen{}Rays, Electrons, A sharp point, Magnetic field, Sound wave

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Characteristics} Electron Shell Levels, Electron Density, Phonons energy levels, Electronic, Spins, Molecular mobility

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Response} Absorption, Reflection, Phase Shift, Scattering, Emission

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Detection} Your eye, Light sensitive film, CCD / CMOS, Scintillator, Transducer

\end{itemize}


\begin{itemize}
\item {} 
\sphinxAtStartPar
Many different imaging modalities ( \(\mu \textrm{CT}\) to MRI to Confocal to Light\sphinxhyphen{}field to AFM).

\item {} 
\sphinxAtStartPar
Similarities in underlying equations, but different \sphinxstyleemphasis{coefficients}, \sphinxstyleemphasis{units}, and \sphinxstyleemphasis{mechanism}

\end{itemize}
\begin{equation*}
\begin{split}I_{measured}(\vec{x})=F_{system}(I_{stimulus}(\vec{x}),S_{sample}(\vec{x}))\end{split}
\end{equation*}

\subsection{Direct Imaging (simple)}
\label{\detokenize{04-BasicSegmentation:direct-imaging-simple}}
\sphinxAtStartPar
In many setups there is un\sphinxhyphen{}even illumination caused by incorrectly adjusted equipment and fluctations in power and setups
\begin{equation*}
\begin{split}F_{system}(a,b)=a*b\end{split}
\end{equation*}\begin{equation*}
\begin{split}I_{stimulus}=\textrm{Beam}_{profile}\end{split}
\end{equation*}\begin{equation*}
\begin{split}S_{system}=\alpha(\vec{x})\longrightarrow\alpha(\vec{x})=\frac{I_{measured}(\vec{x})}{\textrm{Beam}_{profile}(\vec{x})}\end{split}
\end{equation*}
\sphinxAtStartPar
Let’s create a simulated image acquisition with the cell image where you have beam profile that is penetrating the sample:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology} \PYG{k+kn}{import} \PYG{n}{disk}
\PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{ndimage} \PYG{k+kn}{import} \PYG{n}{zoom}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cell\PYGZus{}img} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{rgb2gray}\PYG{p}{(}\PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{figures/Average\PYGZus{}prokaryote\PYGZus{}cell.jpg}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{s\PYGZus{}beam\PYGZus{}img} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pad}\PYG{p}{(}\PYG{n}{disk}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{mode} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{constant}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{constant\PYGZus{}values} \PYG{o}{=} \PYG{l+m+mf}{0.2}\PYG{p}{)}
\PYG{n}{beam\PYGZus{}img} \PYG{o}{=} \PYG{n}{zoom}\PYG{p}{(}\PYG{n}{s\PYGZus{}beam\PYGZus{}img}\PYG{p}{,} \PYG{p}{[}\PYG{n}{cell\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{7.0}\PYG{p}{,} \PYG{n}{cell\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{/}\PYG{l+m+mf}{7.0}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}beam}\PYG{p}{,} \PYG{n}{ax\PYGZus{}img}\PYG{p}{,} \PYG{n}{ax\PYGZus{}det}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax\PYGZus{}beam}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{beam\PYGZus{}img}\PYG{p}{,}         \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}beam}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Beam Profile}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}img}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{,}          \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}img}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sample Profil}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}det}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{o}{*}\PYG{n}{beam\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}det}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Detector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_48_0}.png}


\subsection{Profiles across the image}
\label{\detokenize{04-BasicSegmentation:profiles-across-the-image}}
\sphinxAtStartPar
A first qualitative analysis on images of this type is to extract line profiles to see how the transmitted intensity changes across the sample. What we can see in this particular example is that the acquired profile tapers off with the beam intensity. With this in mind, it may come clear to you that you need to normalize the images by the beam profile.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{o}{*}\PYG{n}{beam\PYGZus{}img}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hlines}\PYG{p}{(}\PYG{n}{beam\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{xmin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{xmax}\PYG{o}{=}\PYG{n}{beam\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{beam\PYGZus{}img}\PYG{p}{[}\PYG{n}{beam\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Beam Profile}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{[}\PYG{n}{beam\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Sample Image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{o}{*}\PYG{n}{beam\PYGZus{}img}\PYG{p}{)}\PYG{p}{[}\PYG{n}{beam\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Detector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Intensity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Position}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lower center}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_51_0}.png}


\subsection{Inhomogeneous illumination}
\label{\detokenize{04-BasicSegmentation:inhomogeneous-illumination}}
\sphinxAtStartPar
Frequently there is a fall\sphinxhyphen{}off of the beam away from the center (as is the case of a Gaussian beam which frequently shows up for laser systems).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{10}\PYG{p}{,}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{matshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{o}{*}\PYG{n}{beam\PYGZus{}img}\PYG{p}{,}\PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_53_0}.png}

\sphinxAtStartPar
This can make extracting detail away from the center much harder.


\subsection{Absorption Imaging (X\sphinxhyphen{}ray, Ultrasound, Optical)}
\label{\detokenize{04-BasicSegmentation:absorption-imaging-x-ray-ultrasound-optical}}
\sphinxAtStartPar
\sphinxstylestrong{For absorption/attenuation imaging \(\rightarrow\) \sphinxhref{http://en.wikipedia.org/wiki/Attenuation\_coefficient}{Beer\sphinxhyphen{}Lambert Law}}
\$\(I_{detector}=\underbrace{I_{source}}_{I_{stimulus}}\underbrace{e^{-\alpha d}}_{S_{sample}}\)\$

\sphinxAtStartPar
Different components have a different \(\alpha\) based on the strength of the interaction between the light and the chemical / nuclear structure of the material
\begin{equation*}
\begin{split}I_{sample}(x,y)=I_{source}\cdot{}e^{-\alpha(x,y)\cdot{}d}\end{split}
\end{equation*}


\sphinxAtStartPar
\sphinxstylestrong{For segmentation this model is:}
\begin{itemize}
\item {} 
\sphinxAtStartPar
there are 2 (or more) distinct components that make up the image

\item {} 
\sphinxAtStartPar
these components are distinguishable by their values (or vectors, colors, tensors, …)

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{pandas} \PYG{k}{as} \PYG{n+nn}{pd}
\end{sphinxVerbatim}


\subsection{A numerical transmission imaging example (1D)}
\label{\detokenize{04-BasicSegmentation:a-numerical-transmission-imaging-example-1d}}
\sphinxAtStartPar
In this example we create a sample with three different materials and the sample thickness 1.0. The attenuation coefficient is modelled by random models to give them some realistic spread.

\sphinxAtStartPar
The transmission uses Beer Lambert’s law.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{I\PYGZus{}source} \PYG{o}{=} \PYG{l+m+mf}{1.0}
\PYG{n}{d} \PYG{o}{=} \PYG{l+m+mf}{1.0}
\PYG{n}{alpha\PYGZus{}1} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{size} \PYG{o}{=} \PYG{l+m+mi}{100}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Material 1}
\PYG{n}{alpha\PYGZus{}2} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{size} \PYG{o}{=} \PYG{l+m+mi}{100}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Material 2}
\PYG{n}{alpha\PYGZus{}3} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{normal}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{size} \PYG{o}{=} \PYG{l+m+mi}{100}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Material 3}

\PYG{n}{abs\PYGZus{}df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{p}{[}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{alpha} \PYG{o}{=} \PYG{n}{c\PYGZus{}x}\PYG{p}{,} \PYG{n}{material} \PYG{o}{=} \PYG{n}{c\PYGZus{}mat}\PYG{p}{)} \PYG{k}{for} \PYG{n}{c\PYGZus{}vec}\PYG{p}{,} \PYG{n}{c\PYGZus{}mat} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{p}{[}\PYG{n}{alpha\PYGZus{}1}\PYG{p}{,} \PYG{n}{alpha\PYGZus{}2}\PYG{p}{,} \PYG{n}{alpha\PYGZus{}3}\PYG{p}{]}\PYG{p}{,} 
                       \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{material 1}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{material 2}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{material 3}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)} \PYG{k}{for} \PYG{n}{c\PYGZus{}x} \PYG{o+ow}{in} \PYG{n}{c\PYGZus{}vec}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{abs\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I\PYGZus{}detector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{I\PYGZus{}source}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{abs\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{*}\PYG{n}{d}\PYG{p}{)}
\PYG{n}{abs\PYGZus{}df}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
        alpha    material  I\PYGZus{}detector
270  3.853025  material 3    0.021215
73   0.886718  material 1    0.412006
178  1.519744  material 2    0.218768
180  1.745622  material 2    0.174536
256  3.399326  material 3    0.033396
\end{sphinxVerbatim}

\sphinxAtStartPar
In the table, you can see that we measure different intensities on the detector depending on the material the beam is penetrating.


\subsubsection{Plotting measured intensities}
\label{\detokenize{04-BasicSegmentation:plotting-measured-intensities}}
\sphinxAtStartPar
Let’s now plot the intensities and attenuation coefficients and compare the outcome of our transmission experiment.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{p}{(}\PYG{n}{ax1}\PYG{p}{,} \PYG{n}{ax2}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax3}\PYG{p}{,} \PYG{n}{ax4}\PYG{p}{)}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}mat}\PYG{p}{,} \PYG{n}{c\PYGZus{}df} \PYG{o+ow}{in} \PYG{n}{abs\PYGZus{}df}\PYG{o}{.}\PYG{n}{groupby}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{material}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{scatter}\PYG{p}{(}\PYG{n}{x} \PYG{o}{=} \PYG{n}{c\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} 
                \PYG{n}{y} \PYG{o}{=} \PYG{n}{c\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I\PYGZus{}detector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} 
                \PYG{n}{label} \PYG{o}{=} \PYG{n}{c\PYGZus{}mat}\PYG{p}{)}
    \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{c\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{alpha}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{n}{c\PYGZus{}mat}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{c\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I\PYGZus{}detector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,}  \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{n}{c\PYGZus{}mat}\PYG{p}{,} \PYG{n}{orientation}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{horizontal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}}\PYG{l+s+se}{\PYGZbs{}\PYGZbs{}}\PYG{l+s+s1}{alpha(x,y)\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize} \PYG{o}{=} \PYG{l+m+mi}{15}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}I\PYGZus{}}\PYG{l+s+si}{\PYGZob{}detector\PYGZcb{}}\PYG{l+s+s1}{\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize} \PYG{o}{=} \PYG{l+m+mi}{18}\PYG{p}{)}

\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax3}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax4}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_63_0}.png}

\sphinxAtStartPar
The material are differently represented!

\sphinxAtStartPar
The \(\alpha\)\sphinxhyphen{}\(I_{detector}\) plot shows the curved exponential behaviour we can expect from Beer Lambert’s law. Now, if we look at the histogram, we can see that distribution of attenuation coefficients doesn’t really match the measured intensity. In this example, it is even so that the widths of the diffent materials have changed places. Great attenuation coefficient results in little transmission and small attenuation coefficient allow more of the beam to penetrate the sample.


\chapter{Example Mammography}
\label{\detokenize{04-BasicSegmentation:example-mammography}}
\sphinxAtStartPar
Mammographic imaging is an area where model\sphinxhyphen{}based absorption imaging is problematic.

\sphinxAtStartPar
Even if we assume a constant illumination (\sphinxstyleemphasis{rarely} the case),
\begin{equation*}
\begin{split}I_{detector}=\underbrace{I_{source}}_{I_{stimulus}}\underbrace{\exp(-\alpha d)}_{S_{sample}}\end{split}
\end{equation*}\begin{equation*}
\begin{split}\downarrow\end{split}
\end{equation*}\begin{equation*}
\begin{split}I_{detector}=\exp(-\alpha(x,y) d(x,y))\end{split}
\end{equation*}\begin{equation*}
\begin{split}\downarrow\end{split}
\end{equation*}\begin{equation*}
\begin{split}I_{detector}=\exp\left(-\int_{0}^{l}\alpha(x,y, z) dz\right)\end{split}
\end{equation*}
\sphinxAtStartPar
The assumption that the attenuation coefficient, \(\alpha\), is constant is rarely valid. Then you see that the exponent turns into an integral along the probing ray and that \(\alpha\) is a function of the position in the sample. This of course leads ambiguity in the interpretation of what the pixel intensity really means.


\section{Problems to interpret radiography images}
\label{\detokenize{04-BasicSegmentation:problems-to-interpret-radiography-images}}
\sphinxAtStartPar
Specifically the problem is related to the inability to separate the
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(\alpha\) \sphinxhyphen{} attenuation

\item {} 
\sphinxAtStartPar
\(d\) \sphinxhyphen{} thickness
terms.

\end{itemize}

\sphinxAtStartPar
To demonstrate this, we model a basic breast volume as a half sphere with a constant absorption factor:


\begin{savenotes}\sphinxattablestart
\centering
\begin{tabulary}{\linewidth}[t]{|T|T|T|}
\hline

\sphinxAtStartPar

&\sphinxstyletheadfamily 
\sphinxAtStartPar
Air
&\sphinxstyletheadfamily 
\sphinxAtStartPar
Breast tissue
\\
\hline
\sphinxAtStartPar
\(\alpha(x,y,z)\)
&
\sphinxAtStartPar
0
&
\sphinxAtStartPar
0.01
\\
\hline
\end{tabulary}
\par
\sphinxattableend\end{savenotes}

\sphinxAtStartPar
\(\rightarrow\) The \(\int\) then turns into a \(\Sigma\) in discrete space


\section{Building a breast phantom}
\label{\detokenize{04-BasicSegmentation:building-a-breast-phantom}}
\sphinxAtStartPar
The breast is here modelled as a half sphere of constant attenuation coefficient:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology} \PYG{k+kn}{import} \PYG{n}{ball}

\PYG{c+c1}{\PYGZsh{} For the 3D rendering}
\PYG{k+kn}{import} \PYG{n+nn}{plotly}\PYG{n+nn}{.}\PYG{n+nn}{offline} \PYG{k}{as} \PYG{n+nn}{py}
\PYG{k+kn}{from} \PYG{n+nn}{plotly}\PYG{n+nn}{.}\PYG{n+nn}{figure\PYGZus{}factory} \PYG{k+kn}{import} \PYG{n}{create\PYGZus{}trisurf}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{measure} \PYG{k+kn}{import} \PYG{n}{marching\PYGZus{}cubes}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{breast\PYGZus{}mask} \PYG{o}{=} \PYG{n}{ball}\PYG{p}{(}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{,}\PYG{l+m+mi}{50}\PYG{p}{:}\PYG{p}{]}  \PYG{c+c1}{\PYGZsh{} This is our model}

\PYG{c+c1}{\PYGZsh{} just for 3D rendering, don\PYGZsq{}t worry about it}
\PYG{n}{py}\PYG{o}{.}\PYG{n}{init\PYGZus{}notebook\PYGZus{}mode}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{vertices}\PYG{p}{,} \PYG{n}{simplices}\PYG{p}{,} \PYG{n}{\PYGZus{}}\PYG{p}{,} \PYG{n}{\PYGZus{}} \PYG{o}{=} \PYG{n}{marching\PYGZus{}cubes}\PYG{p}{(}\PYG{n}{breast\PYGZus{}mask}\PYG{o}{\PYGZgt{}}\PYG{l+m+mi}{0}\PYG{p}{)}
\PYG{n}{x}\PYG{p}{,}\PYG{n}{y}\PYG{p}{,}\PYG{n}{z} \PYG{o}{=} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{o}{*}\PYG{n}{vertices}\PYG{p}{)} 
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{create\PYGZus{}trisurf}\PYG{p}{(}   \PYG{n}{x}\PYG{o}{=}\PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{o}{=}\PYG{n}{y}\PYG{p}{,} \PYG{n}{z}\PYG{o}{=}\PYG{n}{z}\PYG{p}{,} 
                        \PYG{n}{plot\PYGZus{}edges}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,}
                        \PYG{n}{simplices}\PYG{o}{=}\PYG{n}{simplices}\PYG{p}{,}
                        \PYG{n}{title}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Breast Phantom}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{py}\PYG{o}{.}\PYG{n}{iplot}\PYG{p}{(}\PYG{n}{fig}\PYG{p}{)}
\end{sphinxVerbatim}


\subsection{Transmission image of the breast phantom}
\label{\detokenize{04-BasicSegmentation:transmission-image-of-the-breast-phantom}}
\sphinxAtStartPar
Our first step is to simulate a transmission image of the breast. This is done by
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Summing the attenuation coefficents times the pixel size.

\item {} 
\sphinxAtStartPar
Applying Beer\sphinxhyphen{}Lambert’s law

\end{enumerate}

\sphinxAtStartPar
This produces a 2D image of the side view of the breast.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{breast\PYGZus{}alpha} \PYG{o}{=} \PYG{l+m+mf}{1e\PYGZhy{}2}                           \PYG{c+c1}{\PYGZsh{} The attenuation coefficient}
\PYG{n}{pixel\PYGZus{}size}   \PYG{o}{=} \PYG{l+m+mf}{0.1}                            \PYG{c+c1}{\PYGZsh{} The simulated detector has 1mm pixels}
\PYG{n}{breast\PYGZus{}vol}   \PYG{o}{=} \PYG{n}{breast\PYGZus{}alpha}\PYG{o}{*}\PYG{n}{breast\PYGZus{}mask}       \PYG{c+c1}{\PYGZsh{} Scale the image intensity by attenuation coefficient}
\PYG{n}{i\PYGZus{}detector}   \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{breast\PYGZus{}vol}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{*}\PYG{n}{pixel\PYGZus{}size}\PYG{p}{)}  \PYG{c+c1}{\PYGZsh{} Compute the transmission through the phantom}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}hist}\PYG{p}{,} \PYG{n}{ax\PYGZus{}breast}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{b\PYGZus{}img\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ax\PYGZus{}breast}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{i\PYGZus{}detector}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{b\PYGZus{}img\PYGZus{}obj}\PYG{p}{)} \PYG{p}{;}\PYG{n}{ax\PYGZus{}breast}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Transmission image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{i\PYGZus{}detector}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}I\PYGZus{}}\PYG{l+s+si}{\PYGZob{}detector\PYGZcb{}}\PYG{l+s+s1}{\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Distribution of transmission values}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_75_0}.png}

\sphinxAtStartPar
The histogram shows the distribution of the transmitted intensity.


\subsection{Compute the thickness}
\label{\detokenize{04-BasicSegmentation:compute-the-thickness}}
\sphinxAtStartPar
If we know that \(\alpha\) is constant we can reconstruct the thickness \(d\) from the image:
\begin{equation*}
\begin{split} d = -\log(I_{detector})\end{split}
\end{equation*}
\sphinxAtStartPar
This is only valid because we have air (\(\alpha=0\)) as the second component in the phantom. Otherwise, if it was a denser material we would have a material mixture.

\sphinxAtStartPar
Now, let’s compute the breast thickness from the transmission image:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{breast\PYGZus{}thickness} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{i\PYGZus{}detector}\PYG{p}{)}\PYG{o}{/}\PYG{n}{breast\PYGZus{}alpha} \PYG{c+c1}{\PYGZsh{} Compute the thickness}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}hist}\PYG{p}{,} \PYG{n}{ax\PYGZus{}breast}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{b\PYGZus{}img\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ax\PYGZus{}breast}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{breast\PYGZus{}thickness}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}breast}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Thickness image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{b\PYGZus{}img\PYGZus{}obj}\PYG{p}{)}

\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{breast\PYGZus{}thickness}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)} \PYG{p}{;} \PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Breast Thickness (\PYGZdl{}d\PYGZdl{}) [cm]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_80_0}.png}


\subsection{Visualizing the thickness}
\label{\detokenize{04-BasicSegmentation:visualizing-the-thickness}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{mplot3d} \PYG{k+kn}{import} \PYG{n}{Axes3D}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi} \PYG{o}{=} \PYG{l+m+mi}{200}\PYG{p}{)}
\PYG{n}{ax}  \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Plot the surface.}
\PYG{n}{yy}\PYG{p}{,} \PYG{n}{xx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{breast\PYGZus{}thickness}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
                     \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{breast\PYGZus{}thickness}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{surf} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot\PYGZus{}surface}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{breast\PYGZus{}thickness}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{viridis}\PYG{p}{,}
                       \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{antialiased}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{view\PYGZus{}init}\PYG{p}{(}\PYG{n}{elev} \PYG{o}{=} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{azim} \PYG{o}{=} \PYG{l+m+mi}{45}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Breast Thickness}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_82_0}.png}


\section{What if \protect\(\alpha\protect\) is not constant?}
\label{\detokenize{04-BasicSegmentation:what-if-alpha-is-not-constant}}
\sphinxAtStartPar
We run into problems when the \(\alpha\) is no longer constant.
\begin{itemize}
\item {} 
\sphinxAtStartPar
For example if we place a dark lump in the center of the breast.

\item {} 
\sphinxAtStartPar
It is \sphinxstylestrong{impossible} to tell if the breast is \sphinxstyleemphasis{thicker} or if the lump inside is \sphinxstyleemphasis{denser}.

\end{itemize}

\sphinxAtStartPar
For the lump below we can see on the individual slices of the sample that the lesion appears quite clearly and is very strangely shaped.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{breast\PYGZus{}vol} \PYG{o}{=} \PYG{n}{breast\PYGZus{}alpha}\PYG{o}{*}\PYG{n}{breast\PYGZus{}mask}
\PYG{n}{renorm\PYGZus{}slice} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{breast\PYGZus{}mask}\PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{:}\PYG{l+m+mi}{40}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{:}\PYG{l+m+mi}{25}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{breast\PYGZus{}mask}\PYG{p}{[}\PYG{l+m+mi}{30}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{breast\PYGZus{}vol}\PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{:}\PYG{l+m+mi}{40}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{:}\PYG{l+m+mi}{25}\PYG{p}{]} \PYG{o}{/}\PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{stack}\PYG{p}{(}\PYG{p}{[}\PYG{n}{renorm\PYGZus{}slice}\PYG{p}{]}\PYG{o}{*}\PYG{n}{breast\PYGZus{}vol}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{util} \PYG{k+kn}{import} \PYG{n}{montage} \PYG{k}{as} \PYG{n}{montage2d}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{12}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{montage2d}\PYG{p}{(}\PYG{n}{breast\PYGZus{}vol}\PYG{o}{.}\PYG{n}{swapaxes}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{.}\PYG{n}{swapaxes}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{p}{)}\PYG{o}{.}\PYG{n}{transpose}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} 
           \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{vmin} \PYG{o}{=} \PYG{n}{breast\PYGZus{}alpha}\PYG{o}{*}\PYG{o}{.}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{n}{vmax} \PYG{o}{=} \PYG{n}{breast\PYGZus{}alpha}\PYG{o}{*}\PYG{l+m+mf}{1.2}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_84_0}.png}


\subsection{Looking at the thickness again}
\label{\detokenize{04-BasicSegmentation:looking-at-the-thickness-again}}
\sphinxAtStartPar
When we make the projection and apply Beer’s Law we see that it appears as a relatively constant region in the image

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{i\PYGZus{}detector} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{exp}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{breast\PYGZus{}vol}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Compute what the detector sees}

\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}hist}\PYG{p}{,} \PYG{n}{ax\PYGZus{}breast}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{b\PYGZus{}img\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ax\PYGZus{}breast}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{i\PYGZus{}detector}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone\PYGZus{}r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{b\PYGZus{}img\PYGZus{}obj}\PYG{p}{)}

\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{i\PYGZus{}detector}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}I\PYGZus{}}\PYG{l+s+si}{\PYGZob{}detector\PYGZcb{}}\PYG{l+s+s1}{\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_86_0}.png}


\subsection{An anomaly in the thickness reconstruction}
\label{\detokenize{04-BasicSegmentation:an-anomaly-in-the-thickness-reconstruction}}
\sphinxAtStartPar
It appears as a flat constant region in the thickness reconstruction.

\sphinxAtStartPar
So we fundamentally from this single image cannot answer:
\begin{itemize}
\item {} 
\sphinxAtStartPar
is the breast oddly shaped?

\item {} 
\sphinxAtStartPar
or does it have an possible tumor inside of it?

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{breast\PYGZus{}thickness} \PYG{o}{=} \PYG{o}{\PYGZhy{}}\PYG{n}{np}\PYG{o}{.}\PYG{n}{log}\PYG{p}{(}\PYG{n}{i\PYGZus{}detector}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mf}{1e\PYGZhy{}2}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}hist}\PYG{p}{,} \PYG{n}{ax\PYGZus{}breast}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{b\PYGZus{}img\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ax\PYGZus{}breast}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{breast\PYGZus{}thickness}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{b\PYGZus{}img\PYGZus{}obj}\PYG{p}{)}

\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{breast\PYGZus{}thickness}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Breast Thickness (\PYGZdl{}d\PYGZdl{})}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{In cm}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_89_0}.png}


\subsection{Looking at the thickness profile with lump}
\label{\detokenize{04-BasicSegmentation:looking-at-the-thickness-profile-with-lump}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{mpl\PYGZus{}toolkits}\PYG{n+nn}{.}\PYG{n+nn}{mplot3d} \PYG{k+kn}{import} \PYG{n}{Axes3D}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi} \PYG{o}{=} \PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}  \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{gca}\PYG{p}{(}\PYG{n}{projection}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{3d}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the surface.}
\PYG{n}{yy}\PYG{p}{,} \PYG{n}{xx} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{breast\PYGZus{}thickness}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
                       \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{breast\PYGZus{}thickness}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{surf} \PYG{o}{=} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{plot\PYGZus{}surface}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{,} \PYG{n}{breast\PYGZus{}thickness}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{cm}\PYG{o}{.}\PYG{n}{viridis}\PYG{p}{,}
                       \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{antialiased}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{view\PYGZus{}init}\PYG{p}{(}\PYG{n}{elev} \PYG{o}{=} \PYG{l+m+mi}{30}\PYG{p}{,} \PYG{n}{azim} \PYG{o}{=} \PYG{l+m+mi}{130}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}zlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Breast Thickness}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_91_0}.png}


\chapter{Segmentation}
\label{\detokenize{04-BasicSegmentation:segmentation}}

\section{Where does segmentation get us?}
\label{\detokenize{04-BasicSegmentation:where-does-segmentation-get-us}}
\sphinxAtStartPar
We can convert a decimal value or something even more complicated like
\begin{itemize}
\item {} 
\sphinxAtStartPar
3 values for RGB images,

\item {} 
\sphinxAtStartPar
a spectrum for hyperspectral imaging,

\item {} 
\sphinxAtStartPar
or a vector / tensor in a mechanical stress field

\end{itemize}

\sphinxAtStartPar
To a single or a few discrete values:
\begin{itemize}
\item {} 
\sphinxAtStartPar
usually true or false,

\item {} 
\sphinxAtStartPar
but for images with phases it would be each phase, e.g. bone, air, cellular tissue.

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{2560 x 2560 x 2160 x 32 bit = 56GB / sample} \(\rightarrow\) 2560 x 2560 x 2160 x \sphinxstylestrong{1 bit} = 1.75GB / sample


\section{Basic segmentation: Applying a threshold to an image}
\label{\detokenize{04-BasicSegmentation:basic-segmentation-applying-a-threshold-to-an-image}}
\sphinxAtStartPar
Start out with a simple image of a cross with added noise
\$\( I(x,y) = f(x,y) \)\$

\sphinxAtStartPar
Here, we create a test image with two features embedded in uniform noise; a cross with values in the order of ‘1’ and background with values in the order ‘0’. The figure below shows the image and its histogram. The histogram helps us to see how the graylevels are distributed which guides the decision where to put a threshold that segments the cross from the background.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{nx} \PYG{o}{=} \PYG{l+m+mi}{5}\PYG{p}{;} \PYG{n}{ny} \PYG{o}{=} \PYG{l+m+mi}{5}
\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{nx}\PYG{p}{,} \PYG{n}{nx}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{/}\PYG{n}{nx}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} 
                      \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{n}{ny}\PYG{p}{,} \PYG{n}{ny}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{o}{/}\PYG{n}{ny}\PYG{o}{*}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{)}
\PYG{n}{cross\PYGZus{}im} \PYG{o}{=} \PYG{l+m+mf}{1.5}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{*}\PYG{n}{yy}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{*}\PYG{n}{yy}\PYG{p}{)}\PYG{o}{+}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{n}{nx}\PYG{p}{)}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{size} \PYG{o}{=} \PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,}\PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{9}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{im}\PYG{o}{=}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{matshow}\PYG{p}{(}\PYG{n}{cross\PYGZus{}im}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{fig}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{im}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_96_0}.png}


\section{The histogram}
\label{\detokenize{04-BasicSegmentation:the-histogram}}
\sphinxAtStartPar
The intensity can be described with a probability density function
\$\( P_f(x,y) \)\$

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{cross\PYGZus{}im}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}P\PYGZus{}f(x,y)\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Intensity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_99_0}.png}


\section{Applying a threshold to an image}
\label{\detokenize{04-BasicSegmentation:applying-a-threshold-to-an-image}}
\sphinxAtStartPar
By examining the image and probability distribution function, we can \sphinxstyleemphasis{deduce} that the underyling model is a whitish phase that makes up the cross and the darkish background

\sphinxAtStartPar
Applying the threshold is a deceptively simple operation
\begin{equation*}
\begin{split} I(x,y) = 
\begin{cases}
1, & f(x,y)\geq0.40 \\
0, & f(x,y)<0.40
\end{cases}\end{split}
\end{equation*}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{threshold} \PYG{o}{=} \PYG{l+m+mf}{0.4}
\PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n}{cross\PYGZus{}im} \PYG{o}{\PYGZgt{}} \PYG{n}{threshold}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax2}\PYG{p}{,}\PYG{n}{ax1}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{matshow}\PYG{p}{(}\PYG{n}{cross\PYGZus{}im}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{extent} \PYG{o}{=} \PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xx}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{)}\PYG{p}{]}\PYG{o}{*}\PYG{l+m+mf}{0.91}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{)}\PYG{p}{]}\PYG{o}{*}\PYG{l+m+mf}{0.91}\PYG{p}{,}
         \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ks}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markerfacecolor} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{green}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize} \PYG{o}{=} \PYG{l+m+mi}{20}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{cross\PYGZus{}im}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{)}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}P\PYGZus{}f(x,y)\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Intensity}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Pixel Count}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{vlines}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mf}{0.4}\PYG{p}{]}\PYG{p}{,}\PYG{n}{ymin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{ymax}\PYG{o}{=}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_104_0}.png}


\subsection{Various Thresholds}
\label{\detokenize{04-BasicSegmentation:various-thresholds}}
\sphinxAtStartPar
We can see the effect of choosing various thresholds

\sphinxAtStartPar
\(\gamma\in{}\{0.1,0.26,0.42,0.58,0.74,0.9\}\)

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,} 
                          \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}thresh}\PYG{p}{,} \PYG{n}{ax1} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cross\PYGZus{}im}\PYG{p}{,}
               \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} 
               \PYG{n}{extent} \PYG{o}{=} \PYG{p}{[}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{xx}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{min}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{max}\PYG{p}{(}\PYG{p}{)}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n}{cross\PYGZus{}im} \PYG{o}{\PYGZgt{}} \PYG{n}{c\PYGZus{}thresh}

    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{)}\PYG{p}{]}\PYG{o}{*}\PYG{l+m+mf}{0.91}\PYG{p}{,} \PYG{n}{yy}\PYG{p}{[}\PYG{n}{np}\PYG{o}{.}\PYG{n}{where}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{)}\PYG{p}{]}\PYG{o}{*}\PYG{l+m+mf}{0.91}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{rs}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{n}{label} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{img\PYGZgt{}}\PYG{l+s+si}{\PYGZpc{}2.2f}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}} \PYG{n}{c\PYGZus{}thresh}\PYG{p}{,} \PYG{n}{markersize} \PYG{o}{=} \PYG{l+m+mi}{15}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_106_0}.png}

\sphinxAtStartPar
In this fabricated example we saw that thresholding can be a very simple and quick solution to the segmentation problem. Unfortunately, real data is often less obvious. The features we want to identify for our qantitative analysis are often obscured be different other features in the image. They may be part of the setup of caused by the acquisition conditions.


\chapter{Segmenting Cells}
\label{\detokenize{04-BasicSegmentation:segmenting-cells}}
\sphinxAtStartPar
We can peform the same sort of analysis with this image of cells

\sphinxAtStartPar
This time we can derive the model from the basic physics of the system
\begin{itemize}
\item {} 
\sphinxAtStartPar
The field is illuminated by white light of nearly uniform brightness

\item {} 
\sphinxAtStartPar
Cells absorb light causing darker regions to appear in the image

\item {} 
\sphinxAtStartPar
\sphinxstyleemphasis{Lighter} regions have no cells

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Darker} regions have cells

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cell\PYGZus{}img} \PYG{o}{=} \PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{figures/Cell\PYGZus{}Colony.jpg}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax\PYGZus{}hist}\PYG{p}{,} \PYG{n}{ax\PYGZus{}img}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{120}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}hist}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{l+m+mi}{255}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax\PYGZus{}obj} \PYG{o}{=} \PYG{n}{ax\PYGZus{}img}\PYG{o}{.}\PYG{n}{matshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{colorbar}\PYG{p}{(}\PYG{n}{ax\PYGZus{}obj}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_110_0}.png}


\section{Trying different thresholds on the cell image}
\label{\detokenize{04-BasicSegmentation:trying-different-thresholds-on-the-cell-image}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{label2rgb}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,} 
                          \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi} \PYG{o}{=} \PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}thresh}\PYG{p}{,} \PYG{n}{ax1} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{200}\PYG{p}{,} \PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs}\PYG{o}{.}\PYG{n}{flatten}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n}{cell\PYGZus{}img} \PYG{o}{\PYGZlt{}} \PYG{n}{c\PYGZus{}thresh}     

    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{label2rgb}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{,} \PYG{n}{image} \PYG{o}{=} \PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{cell\PYGZus{}img}\PYG{p}{,} \PYG{n}{bg\PYGZus{}label} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{alpha} \PYG{o}{=} \PYG{l+m+mf}{0.4}\PYG{p}{)}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} Rgb coding of image and mask}
    
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{img\PYGZlt{}}\PYG{l+s+si}{\PYGZpc{}2.2f}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}} \PYG{n}{c\PYGZus{}thresh}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_112_0}.png}

\sphinxAtStartPar
There is a graylevel gradient in the image!


\chapter{Other image types}
\label{\detokenize{04-BasicSegmentation:other-image-types}}
\sphinxAtStartPar
While scalar images are easiest, it is possible for any type of image
\$\( I(x,y) = \vec{f}(x,y) \)\$

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\PYG{k+kn}{import} \PYG{n+nn}{pandas} \PYG{k}{as} \PYG{n+nn}{pd}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\end{sphinxVerbatim}

\sphinxAtStartPar
Here, we create an image with vectors to show local orientation and intensities to meassure the streng of a signal.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{nx} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{ny} \PYG{o}{=} \PYG{l+m+mi}{10}
\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{nx}\PYG{p}{)}\PYG{p}{,} 
                      \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{p}{,} \PYG{n}{ny}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{intensity\PYGZus{}img} \PYG{o}{=} \PYG{l+m+mf}{1.5}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{cos}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{*}\PYG{n}{yy}\PYG{p}{)}\PYG{p}{)}\PYG{o}{/}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{xx}\PYG{o}{*}\PYG{n}{yy}\PYG{p}{)}\PYG{o}{+}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{pi}\PYG{o}{/}\PYG{n}{nx}\PYG{p}{)}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{n}{size} \PYG{o}{=} \PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}

\PYG{n}{base\PYGZus{}df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{x} \PYG{o}{=} \PYG{n}{xx}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} 
                            \PYG{n}{y} \PYG{o}{=} \PYG{n}{yy}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} 
                            \PYG{n}{I\PYGZus{}detector} \PYG{o}{=} \PYG{n}{intensity\PYGZus{}img}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{base\PYGZus{}df}\PYG{o}{.}\PYG{n}{apply}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{c\PYGZus{}row}\PYG{p}{:} \PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mf}{1e\PYGZhy{}2}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{base\PYGZus{}df}\PYG{o}{.}\PYG{n}{apply}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{c\PYGZus{}row}\PYG{p}{:} \PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sqrt}\PYG{p}{(}\PYG{l+m+mf}{1e\PYGZhy{}2}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{n}{base\PYGZus{}df}\PYG{o}{.}\PYG{n}{sample}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{)}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
           x         y  I\PYGZus{}detector     x\PYGZus{}vec     y\PYGZus{}vec
85  0.698132  4.886922    0.193711  0.141392  0.989746
76  2.094395  3.490659    0.207917  0.514341  0.857234
7   3.490659 \PYGZhy{}6.283185    0.253510  0.485596 \PYGZhy{}0.874073
11 \PYGZhy{}4.886922 \PYGZhy{}4.886922   \PYGZhy{}0.158919 \PYGZhy{}0.707033 \PYGZhy{}0.707033
44 \PYGZhy{}0.698132 \PYGZhy{}0.698132    1.125334 \PYGZhy{}0.703507 \PYGZhy{}0.703507
\end{sphinxVerbatim}


\section{Looking at colocation histograms}
\label{\detokenize{04-BasicSegmentation:looking-at-colocation-histograms}}
\sphinxAtStartPar
The colocation histogram is a powerful tool to visualize how different components are related to each other. It also called bi\sphinxhyphen{}variate histogram. In seaborn, there is the \sphinxcode{\sphinxupquote{pairplot}} which shows colocation histograms for all combinations on the data. The diagonal is the histogram of the individual components.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{seaborn} \PYG{k}{as} \PYG{n+nn}{sns}
\PYG{n}{sns}\PYG{o}{.}\PYG{n}{pairplot}\PYG{p}{(}\PYG{n}{base\PYGZus{}df}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_120_0}.png}


\section{Vector field plot}
\label{\detokenize{04-BasicSegmentation:vector-field-plot}}
\sphinxAtStartPar
The vector field is a common way to visualiz vector data. It does however only work for small data sets like in this example, otherwise it will be too cluttered and no relevant information will be visible.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{quiver}\PYG{p}{(}\PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{base\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{I\PYGZus{}detector}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_123_0}.png}


\section{Applying a threshold to vector valued image}
\label{\detokenize{04-BasicSegmentation:applying-a-threshold-to-vector-valued-image}}
\sphinxAtStartPar
A threshold is now more difficult to apply since there are now two distinct variables to deal with. The standard approach can be applied to both
\$\( I(x,y) = 
\begin{cases}
1, & \vec{f}_x(x,y) \geq0.25 \text{ and}\\
& \vec{f}_y(x,y) \geq0.25 \\
0, & \text{otherwise}
\end{cases}\)\$

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{thresh\PYGZus{}df} \PYG{o}{=} \PYG{n}{base\PYGZus{}df}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{p}{)}
\PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{thresh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{=} \PYG{n}{thresh\PYGZus{}df}\PYG{o}{.}\PYG{n}{apply}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{c\PYGZus{}row}\PYG{p}{:} \PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{\PYGZgt{}}\PYG{l+m+mf}{0.25} \PYG{o+ow}{and} \PYG{n}{c\PYGZus{}row}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{\PYGZgt{}}\PYG{l+m+mf}{0.25}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{quiver}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{thresh}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Position x}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Position y}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_125_0}.png}


\subsection{Histogram of the vectors}
\label{\detokenize{04-BasicSegmentation:histogram-of-the-vectors}}
\sphinxAtStartPar
This can also be shown on the joint probability distribution as a bivariate histogram.

\sphinxAtStartPar
The lines here indicate the thresholded vector components.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi} \PYG{o}{=} \PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{hist2d}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{thresh\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y\PYGZus{}vec}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{cmap} \PYG{o}{=} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Tresholded}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} 
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}}\PYG{l+s+se}{\PYGZbs{}\PYGZbs{}}\PYG{l+s+s1}{vec}\PYG{l+s+si}{\PYGZob{}f\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}x(x,y)\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZdl{}}\PYG{l+s+se}{\PYGZbs{}\PYGZbs{}}\PYG{l+s+s1}{vec}\PYG{l+s+si}{\PYGZob{}f\PYGZcb{}}\PYG{l+s+s1}{\PYGZus{}y(x,y)\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{vlines}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{,}\PYG{n}{ymin}\PYG{o}{=}\PYG{l+m+mf}{0.25}\PYG{p}{,}\PYG{n}{ymax}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{x=0.25}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{hlines}\PYG{p}{(}\PYG{l+m+mf}{0.25}\PYG{p}{,}\PYG{n}{xmin}\PYG{o}{=}\PYG{l+m+mf}{0.25}\PYG{p}{,}\PYG{n}{xmax}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lightgreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{y=0.25}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{lower left}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_128_0}.png}


\subsection{Applying a threshold}
\label{\detokenize{04-BasicSegmentation:applying-a-threshold}}
\sphinxAtStartPar
Given the presence of two variables; however, more advanced approaches can also be investigated.
\begin{itemize}
\item {} 
\sphinxAtStartPar
For example we can keep only components parallel to the x axis by using the dot product.

\end{itemize}
\begin{equation*}
\begin{split}I(x,y)=
\begin{cases}
1,&|\vec{f}(x,y)\cdot{}\vec{i}|=1\\
0,&\text{otherwise}
\end{cases}\end{split}
\end{equation*}

\subsection{Thresholding orientations}
\label{\detokenize{04-BasicSegmentation:thresholding-orientations}}
\sphinxAtStartPar
We can tune the angular acceptance by using the fact that the scalar product can be expressed using the angle between the the vectors as

\sphinxAtStartPar
\sphinxstylestrong{Scalar product definition}
\begin{equation*}
\begin{split}\vec{x}\cdot\vec{y}=|\vec{x}| |\vec{y}| \cos(\theta_{x\rightarrow y}) \end{split}
\end{equation*}

\begin{equation*}
\begin{split}I(x,y)=
\begin{cases}
1,&\cos^{-1}(\vec{f}(x,y)\cdot \vec{i}) \leq \theta^{\circ} \\
0,&\text{otherwise}
\end{cases}\end{split}
\end{equation*}

\subsubsection{A Machine Learning Approach to Image Processing}
\label{\detokenize{04-BasicSegmentation_Part2:a-machine-learning-approach-to-image-processing}}\label{\detokenize{04-BasicSegmentation_Part2::doc}}







\paragraph{Loading some modules}
\label{\detokenize{04-BasicSegmentation_Part2:loading-some-modules}}
\sphinxAtStartPar
Let’s load a collection of modules for this part.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{k+kn}{import} \PYG{n+nn}{plotsupport} \PYG{k}{as} \PYG{n+nn}{ps}
\PYG{k+kn}{from} \PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics} \PYG{k+kn}{import} \PYG{n}{roc\PYGZus{}auc\PYGZus{}score}
\PYG{k+kn}{import} \PYG{n+nn}{pandas} \PYG{k}{as} \PYG{n+nn}{pd}
\PYG{k+kn}{from} \PYG{n+nn}{collections} \PYG{k+kn}{import} \PYG{n}{OrderedDict}
\PYG{k+kn}{from} \PYG{n+nn}{sklearn}\PYG{n+nn}{.}\PYG{n+nn}{metrics} \PYG{k+kn}{import} \PYG{n}{roc\PYGZus{}curve}

\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{g+gt}{\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}}
\PYG{n+ne}{ModuleNotFoundError}\PYG{g+gWhitespace}{                       }Traceback (most recent call last)
\PYG{o}{\PYGZlt{}}\PYG{n}{ipython}\PYG{o}{\PYGZhy{}}\PYG{n+nb}{input}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{o}{\PYGZhy{}}\PYG{n}{a1f715e67617}\PYG{o}{\PYGZgt{}} \PYG{o+ow}{in} \PYG{o}{\PYGZlt{}}\PYG{n}{module}\PYG{o}{\PYGZgt{}}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{1} \PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{2} \PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{n+ne}{\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZhy{}\PYGZgt{} }\PYG{l+m+mi}{3} \PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{4} \PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{g+gWhitespace}{      }\PYG{l+m+mi}{5} \PYG{k+kn}{import} \PYG{n+nn}{plotsupport} \PYG{k}{as} \PYG{n+nn}{ps}

\PYG{n+ne}{ModuleNotFoundError}: No module named \PYGZsq{}skimage\PYGZsq{}
\end{sphinxVerbatim}


\paragraph{How to approach the analysis}
\label{\detokenize{04-BasicSegmentation_Part2:how-to-approach-the-analysis}}
\sphinxAtStartPar
Segmentation and all the steps leading up to it are really a specialized type of learning problem.

\sphinxAtStartPar
Let’s look at an important problem for electron microscopy imaging…

\sphinxAtStartPar
Identifying the mitochondria in the images like the one to the left in the figures below.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{cell\PYGZus{}img} \PYG{o}{=} \PYG{p}{(}\PYG{l+m+mi}{255}\PYG{o}{\PYGZhy{}}\PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data/em\PYGZus{}image.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mf}{255.0}
\PYG{n}{cell\PYGZus{}seg} \PYG{o}{=} \PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{data/em\PYGZus{}image\PYGZus{}seg.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{[}\PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{p}{:}\PYG{p}{:}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{\PYGZgt{}}\PYG{l+m+mi}{0}

\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax1}\PYG{p}{,} \PYG{n}{ax2}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}        \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}  \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mitochondria}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_5_0}.png}

\sphinxAtStartPar
We want to identify which class each pixel belongs to.

\sphinxAtStartPar
What does identify mean?
\begin{itemize}
\item {} 
\sphinxAtStartPar
Classify the pixels in a mitochondria as \sphinxstyleemphasis{Foreground}

\item {} 
\sphinxAtStartPar
Classify the pixels outside of a mitochondria as \sphinxstyleemphasis{Background}

\end{itemize}

\sphinxAtStartPar
This is a really tedious task and we want to automatize it. Here, segmentation is a good approach. The question is now how we can achieve this.


\paragraph{How do we quantify this?}
\label{\detokenize{04-BasicSegmentation_Part2:how-do-we-quantify-this}}

\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{True Positive} values in the mitochondria that are classified as \sphinxstyleemphasis{Foreground}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{True Negative} values outside the mitochondria that are classified as \sphinxstyleemphasis{Background}

\end{itemize}




\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{False Positive} values outside the mitochondria that are classified as \sphinxstyleemphasis{Foreground}

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{False Negative} values in the mitochondria that are classified as \sphinxstyleemphasis{Background}

\end{itemize}



\sphinxAtStartPar
We can then apply a threshold to the image to determine the number of points in each category

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{thresh}     \PYG{o}{=} \PYG{l+m+mf}{0.52} 
\PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n}{cell\PYGZus{}img} \PYG{o}{\PYGZgt{}} \PYG{n}{thresh} \PYG{c+c1}{\PYGZsh{} Apply a single threshold to the image}

\PYG{c+c1}{\PYGZsh{} Visualization}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mf}{2.5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}  \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}\PYG{n}{bins}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Histogram}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{vlines}\PYG{p}{(}\PYG{n}{thresh}\PYG{p}{,}\PYG{n}{ymin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{ymax}\PYG{o}{=}\PYG{l+m+mi}{12000}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{9}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}   \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Threshold at }\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{thresh}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{p}{,}   \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}   \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Mitochondria Labels}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}             \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_10_0}.png}

\sphinxAtStartPar
In this example we can see that it is clearly not sufficient to apply a single threshold as we have tried before. When we compare the thresholded image to the provided mask, we can see the that there are plenty more structures marked as foreground and also that there are holes within the mitochondria.


\paragraph{Check the performance of the thresholding}
\label{\detokenize{04-BasicSegmentation_Part2:check-the-performance-of-the-thresholding}}
\sphinxAtStartPar
Let’s create a confusion matrix to visualize the performance of the segmentation. A first step is to compute how many hits and misses our segmentation resulted in. In particual, looking at the four different cases that can occur in a binarization.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Suport function for the plot labels}
\PYG{k}{def} \PYG{n+nf}{tp\PYGZus{}func}\PYG{p}{(}\PYG{n}{real\PYGZus{}img\PYGZus{}idx}\PYG{p}{,} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{if} \PYG{n}{real\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{1} \PYG{o+ow}{and} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}009933}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{k}{if} \PYG{n}{real\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Negative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}009933}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{k}{if} \PYG{n}{real\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{0} \PYG{o+ow}{and} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{1}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}cc0000}\PYG{l+s+s1}{\PYGZsq{}}
    \PYG{k}{if} \PYG{n}{real\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{1} \PYG{o+ow}{and} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx} \PYG{o}{==} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Negative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZsh{}cc0000}\PYG{l+s+s1}{\PYGZsq{}}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{out\PYGZus{}results} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{real\PYGZus{}img\PYGZus{}idx}\PYG{p}{,} \PYG{n}{n\PYGZus{}ax} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{m\PYGZus{}ax}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx}\PYG{p}{,} \PYG{n}{c\PYGZus{}ax} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{n\PYGZus{}ax}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{match\PYGZus{}img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{thresh\PYGZus{}img} \PYG{o}{==} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{cell\PYGZus{}seg} \PYG{o}{==} \PYG{n}{real\PYGZus{}img\PYGZus{}idx}\PYG{p}{)}
        \PYG{p}{(}\PYG{n}{tp\PYGZus{}title}\PYG{p}{,}\PYG{n}{color}\PYG{p}{)} \PYG{o}{=} \PYG{n}{tp\PYGZus{}func}\PYG{p}{(}\PYG{n}{real\PYGZus{}img\PYGZus{}idx}\PYG{p}{,} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx}\PYG{p}{)}
        \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{matshow}\PYG{p}{(}\PYG{n}{match\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{n}{tp\PYGZus{}title}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{match\PYGZus{}img}\PYG{p}{)}
        \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s2}{ (}\PYG{l+s+si}{\PYGZob{}1\PYGZcb{}}\PYG{l+s+s2}{)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{tp\PYGZus{}title}\PYG{p}{,}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{n}{tp\PYGZus{}title}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{n}{color}\PYG{p}{)}
        \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_15_0}.png}


\paragraph{The confusion matrix (revisited)}
\label{\detokenize{04-BasicSegmentation_Part2:the-confusion-matrix-revisited}}
\sphinxAtStartPar
From the counts in the previus slide, we can now create a \sphinxhref{https://towardsdatascience.com/understanding-confusion-matrix-a9ad42dcfd62}{Confusion matrix} and also look at the combined image of all the cases. In the hit map we can see white and gray as true segmentation and blue and magenta as false segmentations.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ps}\PYG{o}{.}\PYG{n}{showHitMap}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{p}{,}\PYG{n}{thresh\PYGZus{}img}\PYG{p}{,}\PYG{n}{ax}\PYG{o}{=}\PYG{n}{ax}\PYG{p}{)} \PYG{c+c1}{\PYGZsh{} this is a handy support function provided with the notebook}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_18_0}.png}


\paragraph{Apply Precision and Recall}
\label{\detokenize{04-BasicSegmentation_Part2:apply-precision-and-recall}}
\sphinxAtStartPar
We can use two further metrics to measure the performance of a segmentation method. These are based on the information in the confusion matrix like
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Recall} (sensitivity)  \$\(\frac{TP}{TP+FN}\)\$

\end{itemize}

\sphinxAtStartPar
This is the sum the true positive relative to the number of positives in the mask or also as written here the sum of true positives and false negatives. Recall tells us how good the method is to find the correct label within the mask.
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{Precision}            \$\(\frac{TP}{TP+FP}\)\$

\end{itemize}

\sphinxAtStartPar
This is the sum of true positives relative to the total number of positives provided by our segmentation method. The precision tells us how much our method over segments the image.

\sphinxAtStartPar
Both recall and precision are scalar numbers in the interval \(0<m\leq1\) where ‘1’ is the ideal condition.

\sphinxAtStartPar
Let’s compute precision and recall for our mitochonria example.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Recall: }\PYG{l+s+si}{\PYGZob{}0:0.2f\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{/}
                         \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Negative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
\PYG{n+nb}{print}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Precision: }\PYG{l+s+si}{\PYGZob{}0:0.2f\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{/}
                            \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Recall: 0.82
Precision: 0.18
\end{sphinxVerbatim}

\sphinxAtStartPar
This result tells us that our segmentation was relatively good at finding the mitochondria, but also that this happened at the cost of many false positives.


\subsubsection{Reciever Operating Characteristic (ROC)}
\label{\detokenize{04-BasicSegmentation_Part2:reciever-operating-characteristic-roc}}
\sphinxAtStartPar
ROC curves are a very common tool for analyzing the performance of binary classification systems and there are a large number of tools which can automatically make them.
\begin{itemize}
\item {} 
\sphinxAtStartPar
The concept of the ROC curve was \sphinxhref{https://en.wikipedia.org/wiki/Receiver\_operating\_characteristic\#History}{first developed for WW2 soldiers detecting objects in battlefields using radar}).

\item {} 
\sphinxAtStartPar
As we saw before, for a single threshold value 0.5, we were able to compute a single recall and precision.

\item {} 
\sphinxAtStartPar
The ROC shows the releation between recall and precision for a segmentation model.

\end{itemize}

\sphinxAtStartPar
Let’s compute the hit and miss statistics…

\sphinxAtStartPar
If we want to make an ROC curve we take a number of threshold values and compute the corresponding precision and recall values for each threshold.  In the example below we scan threshold values from 0.1 to 0.9 and compute the hit and miss statistics to calculate the precision and recall.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{out\PYGZus{}vals} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{thresh\PYGZus{}val} \PYG{o+ow}{in} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{0.9}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n}{cell\PYGZus{}img} \PYG{o}{\PYGZgt{}} \PYG{n}{thresh\PYGZus{}val}
    \PYG{k}{for} \PYG{n}{real\PYGZus{}img\PYGZus{}idx} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx} \PYG{o+ow}{in} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{:}
            \PYG{n}{match\PYGZus{}img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{thresh\PYGZus{}img} \PYG{o}{==} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}
                \PYG{n}{cell\PYGZus{}seg} \PYG{o}{==} \PYG{n}{real\PYGZus{}img\PYGZus{}idx}\PYG{p}{)}
            \PYG{n}{tp\PYGZus{}title} \PYG{o}{=} \PYG{n}{tp\PYGZus{}func}\PYG{p}{(}\PYG{n}{real\PYGZus{}img\PYGZus{}idx}\PYG{p}{,} \PYG{n}{pred\PYGZus{}img\PYGZus{}idx}\PYG{p}{)}
            \PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{n}{tp\PYGZus{}title}\PYG{p}{]} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{match\PYGZus{}img}\PYG{p}{)}
    \PYG{n}{out\PYGZus{}vals} \PYG{o}{+}\PYG{o}{=} \PYG{p}{[}
        \PYG{n}{OrderedDict}\PYG{p}{(}
            \PYG{n}{Threshold} \PYG{o}{=} \PYG{n}{thresh\PYGZus{}val}\PYG{p}{,}
            \PYG{n}{Recall}    \PYG{o}{=} \PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{/} \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Negative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{Precision} \PYG{o}{=} \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{/} \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{n}{False\PYGZus{}Positive\PYGZus{}Rate} \PYG{o}{=} \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]} \PYG{o}{/} \PYG{p}{(}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{o}{+}\PYG{n}{out\PYGZus{}results}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Negative}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}
            \PYG{o}{*}\PYG{o}{*}\PYG{n}{out\PYGZus{}results}
        \PYG{p}{)}\PYG{p}{]}

\PYG{n}{roc\PYGZus{}df} \PYG{o}{=} \PYG{n}{pd}\PYG{o}{.}\PYG{n}{DataFrame}\PYG{p}{(}\PYG{n}{out\PYGZus{}vals}\PYG{p}{)}
\PYG{n}{roc\PYGZus{}df}\PYG{o}{.}\PYG{n}{head}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{)}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
   Threshold    Recall  Precision  False\PYGZus{}Positive\PYGZus{}Rate  True Negative  \PYGZbs{}
0   0.100000  0.823512   0.180903             0.344148         118050   
1   0.116327  0.823512   0.180903             0.344148         118050   
2   0.132653  0.823512   0.180903             0.344148         118050   

   False Positive  False Negative  True Positive  (True Negative, \PYGZsh{}009933)  \PYGZbs{}
0           61945            2932          13681                         0   
1           61945            2932          13681                         0   
2           61945            2932          13681                         0   

   (False Positive, \PYGZsh{}cc0000)  (False Negative, \PYGZsh{}cc0000)  \PYGZbs{}
0                     179995                          0   
1                     179995                          0   
2                     179995                          0   

   (True Positive, \PYGZsh{}009933)  
0                     16613  
1                     16613  
2                     16613  
\end{sphinxVerbatim}

\sphinxAtStartPar
… and plot the table.


\paragraph{Making ROC Curves Easier}
\label{\detokenize{04-BasicSegmentation_Part2:making-roc-curves-easier}}
\sphinxAtStartPar
Here we show how it is done with scikit\sphinxhyphen{}image.

\sphinxAtStartPar
Another way of showing the ROC curve (more common for machine learning rather than medical diagnosis) is using the True positive rate and False positive rate
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxstylestrong{True Positive Rate} (recall)= \(TP/(TP+FN)\)

\item {} 
\sphinxAtStartPar
\sphinxstylestrong{False Positive Rate} = \(FP/(FP+TN)\)

\end{itemize}

\sphinxAtStartPar
These show very similar information with the major difference being the goal is to be in the upper left\sphinxhyphen{}hand corner. Additionally random guesses can be shown as the slope 1 line. Therefore for a system to be useful it must lie above the random line.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{120}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{5}\PYG{p}{,}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{roc\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False\PYGZus{}Positive\PYGZus{}Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{,} \PYG{n}{roc\PYGZus{}df}\PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Recall}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}  \PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b.\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ROC Curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r+}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive Rate / Recall}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{upper right}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_34_0}.png}


\subparagraph{ROC curve for mitochondria image segmentation}
\label{\detokenize{04-BasicSegmentation_Part2:roc-curve-for-mitochondria-image-segmentation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{n}{thresholds} \PYG{o}{=} \PYG{n}{roc\PYGZus{}curve}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}\PYG{p}{,}
                                 \PYG{n}{cell\PYGZus{}img}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{b.\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}  \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ROC Curve}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r+}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{g\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Random Guessing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_36_0}.png}


\paragraph{Explore the impact of different filters on the ROC}
\label{\detokenize{04-BasicSegmentation_Part2:explore-the-impact-of-different-filters-on-the-roc}}
\sphinxAtStartPar
We have already seen what the ROC curve looks like for the original data. Some weeks ago we learnt about a lot of filters and now it is time to see how these can be used in an attempt to improve the ROC. In this example we will compare the unfiltered image to:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Gaussian filter (\(\sigma=2\))

\item {} 
\sphinxAtStartPar
Difference of Gaussian \(x-G_{sigma=3}*x\)

\item {} 
\sphinxAtStartPar
Median size 3x3
And see what performance improvements we can achieve

\end{itemize}

\sphinxAtStartPar
Let’s produce some filtered images:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{filters} \PYG{k+kn}{import} \PYG{n}{gaussian}\PYG{p}{,} \PYG{n}{median}

\PYG{k}{def} \PYG{n+nf}{no\PYGZus{}filter}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}               \PYG{k}{return}  \PYG{n}{x}
\PYG{k}{def} \PYG{n+nf}{gaussian\PYGZus{}filter}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}         \PYG{k}{return}  \PYG{n}{gaussian}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{sigma}\PYG{o}{=}\PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{diff\PYGZus{}of\PYGZus{}gaussian\PYGZus{}filter}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:} \PYG{k}{return}  \PYG{n}{x}\PYG{o}{\PYGZhy{}}\PYG{n}{gaussian}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{sigma}\PYG{o}{=}\PYG{l+m+mi}{3}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{median\PYGZus{}filter}\PYG{p}{(}\PYG{n}{x}\PYG{p}{)}\PYG{p}{:}           \PYG{k}{return}  \PYG{n}{median}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,} \PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{)}
\PYG{n}{m\PYGZus{}axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}filt}\PYG{p}{,} \PYG{n}{c\PYGZus{}ax} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{p}{[}\PYG{n}{no\PYGZus{}filter}\PYG{p}{,} \PYG{n}{gaussian\PYGZus{}filter}\PYG{p}{,} \PYG{n}{diff\PYGZus{}of\PYGZus{}gaussian\PYGZus{}filter}\PYG{p}{,} \PYG{n}{median\PYGZus{}filter}\PYG{p}{]}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{c\PYGZus{}filt}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{n}{c\PYGZus{}filt}\PYG{o}{.}\PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_40_0}.png}


\subparagraph{ROC curves of filtered images}
\label{\detokenize{04-BasicSegmentation_Part2:roc-curves-of-filtered-images}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{l+m+mf}{0.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r+}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Ideal}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{k\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Random Guessing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{colors} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cornflowerblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mediumseagreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tomato}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{color}\PYG{p}{,}\PYG{n}{c\PYGZus{}filt} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{colors}\PYG{p}{,}\PYG{p}{[}\PYG{n}{no\PYGZus{}filter}\PYG{p}{,} \PYG{n}{gaussian\PYGZus{}filter}\PYG{p}{,} \PYG{n}{diff\PYGZus{}of\PYGZus{}gaussian\PYGZus{}filter}\PYG{p}{,} \PYG{n}{median\PYGZus{}filter}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{n}{thresholds} \PYG{o}{=} \PYG{n}{roc\PYGZus{}curve}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}\PYG{p}{,} \PYG{n}{c\PYGZus{}filt}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{)}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ROC Curve (}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{c\PYGZus{}filt}\PYG{o}{.}\PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{n}{color}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Decorations}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.5}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{center right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_42_0}.png}


\paragraph{Area Under the Curve (AUC)}
\label{\detokenize{04-BasicSegmentation_Part2:area-under-the-curve-auc}}
\sphinxAtStartPar
We can then use this ROC curve to compare different filters (or even entire workflows), if the area is higher the approach is better.

\sphinxAtStartPar
Different approaches can be compared by \sphinxstyleemphasis{Area Under the Curve} (AUC) which is a scalar.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}
\PYG{n}{colors} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cornflowerblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gold}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{mediumseagreen}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{tomato}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{scores} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{k}{for} \PYG{n}{color}\PYG{p}{,} \PYG{n}{c\PYGZus{}filt} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{colors}\PYG{p}{,}\PYG{p}{[}\PYG{n}{no\PYGZus{}filter}\PYG{p}{,} \PYG{n}{gaussian\PYGZus{}filter}\PYG{p}{,} \PYG{n}{diff\PYGZus{}of\PYGZus{}gaussian\PYGZus{}filter}\PYG{p}{,} \PYG{n}{median\PYGZus{}filter}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{fimg} \PYG{o}{=} \PYG{n}{c\PYGZus{}filt}\PYG{p}{(}\PYG{n}{cell\PYGZus{}img}\PYG{p}{)}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{n}{thresholds} \PYG{o}{=} \PYG{n}{roc\PYGZus{}curve}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}\PYG{p}{,} \PYG{n}{fimg}\PYG{p}{)}
    \PYG{n}{scores}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{roc\PYGZus{}auc\PYGZus{}score}\PYG{p}{(}\PYG{n}{cell\PYGZus{}seg}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}\PYG{p}{,}  \PYG{n}{fimg}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{markersize}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{color}\PYG{p}{,}\PYG{n}{label}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{c\PYGZus{}filt}\PYG{o}{.}\PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{fill\PYGZus{}between}\PYG{p}{(}\PYG{n}{fpr}\PYG{p}{,} \PYG{n}{tpr}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{alpha}\PYG{o}{=}\PYG{l+m+mf}{0.2}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{color}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylim}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.1}\PYG{p}{,} \PYG{l+m+mf}{1.1}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{False Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{True Positive Rate}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{ROC curves}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{legend}\PYG{p}{(}\PYG{n}{loc}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lower right}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{7}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{names} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{No filter}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gaussian}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Diff of Gaussian}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Median}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{bar}\PYG{p}{(}\PYG{n}{names}\PYG{p}{,}\PYG{n}{scores}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{n}{colors}\PYG{p}{)}\PYG{p}{;} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{xlabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Filter type}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Score}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Area und curve (AUC)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_44_0}.png}

\sphinxAtStartPar
Armed with these tools we are ready to analyze the performance of the segmentation methods we develop to solve our image analysis tasks.


\subsubsection{Segmenting multiple phases}
\label{\detokenize{04-BasicSegmentation_Part2:segmenting-multiple-phases}}

\paragraph{Multiple Phases example: Segmenting Shale}
\label{\detokenize{04-BasicSegmentation_Part2:multiple-phases-example-segmenting-shale}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Shale provided from \sphinxstyleemphasis{Kanitpanyacharoen, W. (2012). Synchrotron X\sphinxhyphen{}ray Applications Toward an Understanding of Elastic Anisotropy.}

\item {} 
\sphinxAtStartPar
Here we have a shale sample measured with X\sphinxhyphen{}ray tomography with three different phases inside (clay, rock, and air).

\item {} 
\sphinxAtStartPar
The model is that because the chemical composition and density of each phase is different they will absorb different amounts of x\sphinxhyphen{}rays and appear as different brightnesses in the image

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{color} \PYG{k+kn}{import} \PYG{n}{rgb2gray}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{shale\PYGZus{}img} \PYG{o}{=} \PYG{n}{imread}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{figures/ShaleSample.jpg}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{o}{/}\PYG{l+m+mf}{255.0}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax1} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{120}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{shale\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_49_0}.png}


\subparagraph{Finding three categories}
\label{\detokenize{04-BasicSegmentation_Part2:finding-three-categories}}
\sphinxAtStartPar
Let’s take a look at the histogram as always when we face a segmentation task…

\sphinxAtStartPar
Ideally we would derive 3 values for the thresholds based on a model for the composition of each phase and how much it absorbs, but that is not always possible or practical.
\begin{itemize}
\item {} 
\sphinxAtStartPar
While there are 3 phases clearly visible in the image, the histogram is less telling (even after being re\sphinxhyphen{}scaled).

\end{itemize}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{shale\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Shale image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{shale\PYGZus{}img}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Histogram of the shale image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_52_0}.png}


\subsubsection{Multiple Segmentations}
\label{\detokenize{04-BasicSegmentation_Part2:multiple-segmentations}}
\sphinxAtStartPar
For this exercise we choose arbitrarily 3 ranges for the different phases and perform visual inspection

\sphinxAtStartPar
The relation can explicitly be written out as
\$\( I(x) = 
\begin{cases}
\text{Void}, & 0 \leq x \leq 0.3  \\
\text{Clay}, & 0.3 < x \leq 0.5 \\
\text{Rock}, & 0.5 < x
\end{cases}\)\$

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{=}\PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{,}\PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{hist}\PYG{p}{(}\PYG{n}{shale\PYGZus{}img}\PYG{o}{.}\PYG{n}{ravel}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Histogram of the shale image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{n}{thresholds} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{]}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{vlines}\PYG{p}{(}\PYG{n}{thresholds}\PYG{p}{,}\PYG{n}{ymin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{n}{ymax}\PYG{o}{=}\PYG{l+m+mi}{600}\PYG{p}{,}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{r}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{fs}\PYG{o}{=}\PYG{l+m+mi}{18}\PYG{p}{;} \PYG{n}{ypos}\PYG{o}{=}\PYG{l+m+mi}{600}\PYG{p}{;} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.18}\PYG{p}{,}\PYG{n}{ypos}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Void}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.38}\PYG{p}{,}\PYG{n}{ypos}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Clay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{)}\PYG{p}{,}\PYG{n}{ax}\PYG{o}{.}\PYG{n}{text}\PYG{p}{(}\PYG{l+m+mf}{0.7}\PYG{p}{,}\PYG{n}{ypos}\PYG{p}{,}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Rock}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{n}{fs}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_54_0}.png}


\paragraph{Segmentation result}
\label{\detokenize{04-BasicSegmentation_Part2:segmentation-result}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{4}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{m\PYGZus{}axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{shale\PYGZus{}img}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{m\PYGZus{}axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Shale Image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{m\PYGZus{}axs}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{used\PYGZus{}vox} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{shale\PYGZus{}img}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{uint8}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}ax}\PYG{p}{,} \PYG{n}{c\PYGZus{}max}\PYG{p}{,} \PYG{n}{c\PYGZus{}title} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{m\PYGZus{}axs}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mf}{0.3}\PYG{p}{,} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Void}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Clay}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Rock}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{c\PYGZus{}slice} \PYG{o}{=} \PYG{p}{(}\PYG{n}{shale\PYGZus{}img} \PYG{o}{\PYGZlt{}} \PYG{n}{c\PYGZus{}max}\PYG{p}{)}\PYG{o}{\PYGZhy{}}\PYG{n}{used\PYGZus{}vox}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{c\PYGZus{}slice}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{used\PYGZus{}vox} \PYG{o}{+}\PYG{o}{=} \PYG{n}{c\PYGZus{}slice}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}0\PYGZcb{}}\PYG{l+s+s1}{ (x\PYGZlt{}}\PYG{l+s+si}{\PYGZob{}1:0.1f\PYGZcb{}}\PYG{l+s+s1}{)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{c\PYGZus{}title}\PYG{p}{,} \PYG{n}{c\PYGZus{}max}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_56_0}.png}

\sphinxAtStartPar
Segmenting multiple phases is a non\sphinxhyphen{}trivial problem. In particular, when the edges in the image as smooth and at low SNR. We will look into these problems next week.


\subsubsection{Implementation of thresholding}
\label{\detokenize{04-BasicSegmentation_Part2:implementation-of-thresholding}}
\sphinxAtStartPar
The implementations of basic thresholds and segmentations is very easy since it is a unary operation of a single image
\$\( f(I(\vec{x})) \)\$

\sphinxAtStartPar
How is this implemented with using a programming language?

\sphinxAtStartPar
In mathematical terms this is called a map and since it does not require information from neighboring voxels or images it can be calculated for each point independently (\sphinxstyleemphasis{parallel}). Filters on the other hand almost always depend on neighboring voxels and thus the calculations are not as easy to seperate.


\paragraph{Implementation using script languages}
\label{\detokenize{04-BasicSegmentation_Part2:implementation-using-script-languages}}

\subparagraph{Python (numpy) and Matlab}
\label{\detokenize{04-BasicSegmentation_Part2:python-numpy-and-matlab}}
\sphinxAtStartPar
The simplest is a single threshold in numpy and Matlab:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{thresh\PYGZus{}img}\PYG{+w}{ }\PYG{p}{=}\PYG{+w}{ }\PYG{n}{gray\PYGZus{}img}\PYG{+w}{ }\PYG{o}{\PYGZgt{}}\PYG{+w}{ }\PYG{n}{thresh}
\end{sphinxVerbatim}

\sphinxAtStartPar
A more complicated threshold:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{gray\PYGZus{}img} \PYG{o}{\PYGZgt{}} \PYG{n}{thresh\PYGZus{}a}\PYG{p}{)} \PYG{o}{\PYGZam{}} \PYG{p}{(}\PYG{n}{gray\PYGZus{}img} \PYG{o}{\PYGZlt{}} \PYG{n}{thresh\PYGZus{}b}\PYG{p}{)}
\end{sphinxVerbatim}


\subparagraph{Python}
\label{\detokenize{04-BasicSegmentation_Part2:python}}
\sphinxAtStartPar
The task is slightly more complicated when you use standard python. Here, you have to define a mapping function with a lambda to perform the thresholding.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n+nb}{map}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{gray\PYGZus{}val}\PYG{p}{:} \PYG{n}{gray\PYGZus{}val}\PYG{o}{\PYGZgt{}}\PYG{n}{thresh}\PYG{p}{,} \PYG{n}{gray\PYGZus{}img}\PYG{p}{)}
\end{sphinxVerbatim}


\paragraph{Implementation using traditional programming languages}
\label{\detokenize{04-BasicSegmentation_Part2:implementation-using-traditional-programming-languages}}
\sphinxAtStartPar
In traditional programming languages you have to write some moer code as there are no predefined functions that operate directly on arrays. This means, you’ll have to implement the loops yourself.


\subparagraph{Java}
\label{\detokenize{04-BasicSegmentation_Part2:java}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kt}{boolean}\PYG{o}{[}\PYG{o}{]} \PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{k}{new} \PYG{k+kt}{boolean}\PYG{o}{[}\PYG{n}{x\PYGZus{}size}\PYG{o}{*}\PYG{n}{y\PYGZus{}size}\PYG{o}{*}\PYG{n}{z\PYGZus{}size}\PYG{o}{]}\PYG{p}{;}
\PYG{k}{for}\PYG{p}{(}\PYG{k+kt}{int} \PYG{n}{x}\PYG{o}{=}\PYG{n}{x\PYGZus{}min}\PYG{p}{;}\PYG{n}{x}\PYG{o}{\PYGZlt{}}\PYG{n}{x\PYGZus{}max}\PYG{p}{;}\PYG{n}{x}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}
  \PYG{k}{for}\PYG{p}{(}\PYG{k+kt}{int} \PYG{n}{y}\PYG{o}{=}\PYG{n}{y\PYGZus{}min}\PYG{p}{;}\PYG{n}{y}\PYG{o}{\PYGZlt{}}\PYG{n}{y\PYGZus{}max}\PYG{p}{;}\PYG{n}{y}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}
    \PYG{k}{for}\PYG{p}{(}\PYG{k+kt}{int} \PYG{n}{z}\PYG{o}{=}\PYG{n}{z\PYGZus{}min}\PYG{p}{;}\PYG{n}{z}\PYG{o}{\PYGZlt{}}\PYG{n}{z\PYGZus{}max}\PYG{p}{;}\PYG{n}{z}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)} \PYG{p}{\PYGZob{}}
      \PYG{k+kt}{int} \PYG{n}{offset}\PYG{o}{=}\PYG{p}{(}\PYG{n}{z}\PYG{o}{*}\PYG{n}{y\PYGZus{}size}\PYG{o}{+}\PYG{n}{y}\PYG{p}{)}\PYG{o}{*}\PYG{n}{x\PYGZus{}size}\PYG{o}{+}\PYG{n}{x}\PYG{p}{;}
      \PYG{n}{thresh\PYGZus{}img}\PYG{o}{[}\PYG{n}{offset}\PYG{o}{]}\PYG{o}{=}\PYG{n}{gray\PYGZus{}img}\PYG{o}{[}\PYG{n}{offset}\PYG{o}{]}\PYG{o}{\PYGZgt{}}\PYG{n}{thresh}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\subparagraph{C/C++}
\label{\detokenize{04-BasicSegmentation_Part2:c-c}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kt}{bool}\PYG{o}{*} \PYG{n}{thresh\PYGZus{}img} \PYG{o}{=} \PYG{n}{malloc}\PYG{p}{(}\PYG{n}{x\PYGZus{}size}\PYG{o}{*}\PYG{n}{y\PYGZus{}size}\PYG{o}{*}\PYG{n}{z\PYGZus{}size} \PYG{o}{*} \PYG{k}{sizeof} \PYG{p}{(}\PYG{k+kt}{bool}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

\PYG{k}{for}\PYG{p}{(}\PYG{k+kt}{int} \PYG{n}{x}\PYG{o}{=}\PYG{n}{x\PYGZus{}min}\PYG{p}{;}\PYG{n}{x}\PYG{o}{\PYGZlt{}}\PYG{n}{x\PYGZus{}max}\PYG{p}{;}\PYG{n}{x}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}
  \PYG{k}{for}\PYG{p}{(}\PYG{k+kt}{int} \PYG{n}{y}\PYG{o}{=}\PYG{n}{y\PYGZus{}min}\PYG{p}{;}\PYG{n}{y}\PYG{o}{\PYGZlt{}}\PYG{n}{y\PYGZus{}max}\PYG{p}{;}\PYG{n}{y}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)}
    \PYG{k}{for}\PYG{p}{(}\PYG{k+kt}{int} \PYG{n}{z}\PYG{o}{=}\PYG{n}{z\PYGZus{}min}\PYG{p}{;}\PYG{n}{z}\PYG{o}{\PYGZlt{}}\PYG{n}{z\PYGZus{}max}\PYG{p}{;}\PYG{n}{z}\PYG{o}{+}\PYG{o}{+}\PYG{p}{)} \PYG{p}{\PYGZob{}}
      \PYG{k+kt}{int} \PYG{n}{offset}\PYG{o}{=}\PYG{p}{(}\PYG{n}{z}\PYG{o}{*}\PYG{n}{y\PYGZus{}size}\PYG{o}{+}\PYG{n}{y}\PYG{p}{)}\PYG{o}{*}\PYG{n}{x\PYGZus{}size}\PYG{o}{+}\PYG{n}{x}\PYG{p}{;}
      \PYG{n}{thresh\PYGZus{}img}\PYG{p}{[}\PYG{n}{offset}\PYG{p}{]}\PYG{o}{=}\PYG{n}{gray\PYGZus{}img}\PYG{p}{[}\PYG{n}{offset}\PYG{p}{]}\PYG{o}{\PYGZgt{}}\PYG{n}{thresh}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
\end{sphinxVerbatim}


\subparagraph{Alternative solution}
\label{\detokenize{04-BasicSegmentation_Part2:alternative-solution}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Image are stored as a sequence of numbers, not matter the number of dimensions.

\item {} 
\sphinxAtStartPar
The pixel neighborhood is not considered.

\item {} 
\sphinxAtStartPar
A single loop can be used!

\end{itemize}


\subsubsection{Morphology}
\label{\detokenize{04-BasicSegmentation_Part2:morphology}}
\sphinxAtStartPar
We can now utilize information from neighborhood voxels to improve the results.

\sphinxAtStartPar
These steps are called morphological operations.

\sphinxAtStartPar
Like filtering the assumption behind morphological operations are
\begin{itemize}
\item {} 
\sphinxAtStartPar
nearby voxels in \sphinxstylestrong{real} images are related / strongly correlated with one another

\item {} 
\sphinxAtStartPar
noise and imaging artifacts are less spatially correlated.

\end{itemize}

\sphinxAtStartPar
Therefore these imaging problems can be alleviated by adjusting the balance between local and neighborhood values.


\paragraph{Noisy segmentation}
\label{\detokenize{04-BasicSegmentation_Part2:noisy-segmentation}}
\sphinxAtStartPar
We return to the original image of a cross:

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{nx} \PYG{o}{=} \PYG{l+m+mi}{20}
\PYG{n}{ny} \PYG{o}{=} \PYG{l+m+mi}{20}
\PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy} \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{nx}\PYG{p}{)}\PYG{p}{,}
                     \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{10}\PYG{p}{,} \PYG{n}{ny}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{seed}\PYG{p}{(}\PYG{l+m+mi}{2018}\PYG{p}{)}
\PYG{n}{cross\PYGZus{}im} \PYG{o}{=} \PYG{l+m+mf}{1.1}\PYG{o}{*}\PYG{p}{(}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{o}{+}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{abs}\PYG{p}{(}\PYG{n}{yy}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{l+m+mi}{2}\PYG{p}{)}\PYG{p}{)} \PYG{o}{+} \PYGZbs{}
    \PYG{n}{np}\PYG{o}{.}\PYG{n}{random}\PYG{o}{.}\PYG{n}{uniform}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{n}{size}\PYG{o}{=}\PYG{n}{xx}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}

\PYG{n}{thimg} \PYG{o}{=} \PYG{n}{cross\PYGZus{}im} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.8} \PYG{c+c1}{\PYGZsh{} Let\PYGZsq{}s apply a threshold}

\PYG{n}{fig}\PYG{p}{,} \PYG{p}{(}\PYG{n}{ax1}\PYG{p}{,} \PYG{n}{ax2}\PYG{p}{)} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{6}\PYG{p}{,} \PYG{l+m+mf}{3.5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cross\PYGZus{}im}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{hot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax1}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Image}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{thimg}\PYG{p}{)}
\PYG{n}{ax2}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Simple Thresholding}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_64_0}.png}

\sphinxAtStartPar
We have a lot of misclassified pixels here!


\paragraph{Fundamentals: Neighborhood}
\label{\detokenize{04-BasicSegmentation_Part2:fundamentals-neighborhood}}
\sphinxAtStartPar
A neighborhood consists of the pixels or voxels which are of sufficient proximity to a given point. There are a number of possible definitions which largely affect the result when it is invoked.
\begin{itemize}
\item {} 
\sphinxAtStartPar
A large neighborhood performs operations over larger areas / volumes

\item {} 
\sphinxAtStartPar
Computationally intensive

\item {} 
\sphinxAtStartPar
Can \sphinxstyleemphasis{smooth} out features

\item {} 
\sphinxAtStartPar
A small neighborhood performs operations over small areas / volumes

\item {} 
\sphinxAtStartPar
Computationally cheaper

\item {} 
\sphinxAtStartPar
Struggles with large noise / filling large holes

\end{itemize}


\subparagraph{Why do we need neighborhods}
\label{\detokenize{04-BasicSegmentation_Part2:why-do-we-need-neighborhods}}
\sphinxAtStartPar
The neighborhood is important for a large number of image and other (communication, mapping, networking) processing operations:
\begin{itemize}
\item {} 
\sphinxAtStartPar
filtering

\item {} 
\sphinxAtStartPar
morphological operations

\item {} 
\sphinxAtStartPar
component labeling

\item {} 
\sphinxAtStartPar
distance maps

\item {} 
\sphinxAtStartPar
image correlation based tracking methods

\end{itemize}

\sphinxAtStartPar
It is often called structuring element (or \sphinxcode{\sphinxupquote{selem}} for sort / code), but has exactly the same meaning


\subparagraph{Fundamentals: Neighbors in 2D}
\label{\detokenize{04-BasicSegmentation_Part2:fundamentals-neighbors-in-2d}}
\sphinxAtStartPar
For standard image operations there are two definitions of neighborhood.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{se_r1}.pdf}
\caption{4\sphinxhyphen{}connected pixel neighborhood for 2D images.}\label{\detokenize{04-BasicSegmentation_Part2:id1}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{se_rsqrt2}.pdf}
\caption{8\sphinxhyphen{}connected pixel neighborhood for 2D images.}\label{\detokenize{04-BasicSegmentation_Part2:id2}}\end{figure}



\sphinxAtStartPar
The 4 and 8 adjacent neighbors shown below. Given the blue pixel in the center the red are the 4\sphinxhyphen{}adjacent and the red and green make up the 8 adjacent. We expand beyond this to disk, cross, vertical and horizontal lines


\subparagraph{More neighborhood shapes}
\label{\detokenize{04-BasicSegmentation_Part2:more-neighborhood-shapes}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology} \PYG{k+kn}{import} \PYG{n}{disk}\PYG{p}{,} \PYG{n}{octagon} \PYG{k}{as} \PYG{n}{oct\PYGZus{}func}\PYG{p}{,} \PYG{n}{star}

\PYG{k}{def} \PYG{n+nf}{h\PYGZus{}line}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:} \PYG{k}{return} \PYG{n}{np}\PYG{o}{.}\PYG{n}{pad}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{ones}\PYG{p}{(}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{o}{*}\PYG{n}{n}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{p}{[}\PYG{p}{[}\PYG{n}{n}\PYG{p}{,} \PYG{n}{n}\PYG{p}{]}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,} \PYG{n}{mode}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{constant}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{constant\PYGZus{}values}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{v\PYGZus{}line}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:} \PYG{k}{return} \PYG{n}{h\PYGZus{}line}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{o}{.}\PYG{n}{T}

\PYG{k}{def} \PYG{n+nf}{cross}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:} \PYG{k}{return} \PYG{p}{(}\PYG{p}{(}\PYG{n}{h\PYGZus{}line}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{o}{+}\PYG{n}{v\PYGZus{}line}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZgt{}} \PYG{l+m+mi}{0}\PYG{p}{)}\PYG{o}{.}\PYG{n}{astype}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{octagon}\PYG{p}{(}\PYG{n}{n}\PYG{p}{)}\PYG{p}{:} \PYG{k}{return} \PYG{n}{oct\PYGZus{}func}\PYG{p}{(}\PYG{n}{n}\PYG{p}{,} \PYG{n}{n}\PYG{p}{)}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{neighbor\PYGZus{}functions} \PYG{o}{=} \PYG{p}{[}\PYG{n}{disk}\PYG{p}{,} \PYG{n}{cross}\PYG{p}{,} \PYG{n}{h\PYGZus{}line}\PYG{p}{,} \PYG{n}{v\PYGZus{}line}\PYG{p}{,} \PYG{n}{star}\PYG{p}{,} \PYG{n}{octagon}\PYG{p}{]}
\PYG{n}{sizes} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+m+mi}{3}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{]}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sizes}\PYG{p}{)}\PYG{p}{,}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{neighbor\PYGZus{}functions}\PYG{p}{)}\PYG{p}{,}
                           \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,} \PYG{l+m+mi}{7}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}dim}\PYG{p}{,} \PYG{n}{c\PYGZus{}axs} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{sizes}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{c\PYGZus{}func}\PYG{p}{,} \PYG{n}{c\PYGZus{}ax} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{neighbor\PYGZus{}functions}\PYG{p}{,} \PYG{n}{c\PYGZus{}axs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{c\PYGZus{}func}\PYG{p}{(}\PYG{n}{c\PYGZus{}dim}\PYG{p}{)}\PYG{p}{,} \PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{bone}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{interpolation}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{none}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
        \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{ }\PYG{l+s+si}{\PYGZob{}\PYGZcb{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{c\PYGZus{}func}\PYG{o}{.}\PYG{n+nv+vm}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{,} \PYG{n}{c\PYGZus{}func}\PYG{p}{(}\PYG{n}{c\PYGZus{}dim}\PYG{p}{)}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}\PYG{p}{)}
        
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{suptitle}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Different neighborhood shapes and sizes}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{fontsize}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_74_0}.png}


\subparagraph{Fundamentals: Neighbors in 3D}
\label{\detokenize{04-BasicSegmentation_Part2:fundamentals-neighbors-in-3d}}
\sphinxAtStartPar
Neighborhoods in 3D include the planes above and below the center pixel in addition to the neighbors in the same plane.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{se_r1}.pdf}
\caption{4\sphinxhyphen{}connected pixel neighborhood for 2D images.}\label{\detokenize{04-BasicSegmentation_Part2:id3}}\end{figure}

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[width=400\sphinxpxdimen]{{se_rsqrt2}.pdf}
\caption{8\sphinxhyphen{}connected pixel neighborhood for 2D images.}\label{\detokenize{04-BasicSegmentation_Part2:id4}}\end{figure}




\paragraph{Erosion and Dilation}
\label{\detokenize{04-BasicSegmentation_Part2:erosion-and-dilation}}
\sphinxAtStartPar
\sphinxstylestrong{Erosion}

\sphinxAtStartPar
If any of the voxels in the neighborhood are 0/false than the voxel will be set to 0
\begin{itemize}
\item {} 
\sphinxAtStartPar
Has the effect of peeling the surface layer off of an object

\end{itemize}

\sphinxAtStartPar
\sphinxstylestrong{Dilation}

\sphinxAtStartPar
If any of the voxels in the neigbhorhood are 1/true then the voxel will be set to 1
\begin{itemize}
\item {} 
\sphinxAtStartPar
Has the effect of adding a layer onto an object (dunking an strawberry in chocolate, adding a coat of paint to a car)

\end{itemize}


\subparagraph{Applied Erosion and Dilation}
\label{\detokenize{04-BasicSegmentation_Part2:applied-erosion-and-dilation}}
\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{import} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{morphology} \PYG{k}{as} \PYG{n+nn}{morph}

\PYG{n}{s}\PYG{o}{=}\PYG{l+m+mf}{255.0}
\PYG{n}{cmap} \PYG{o}{=} \PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{230}\PYG{o}{/}\PYG{n}{s}\PYG{p}{,}\PYG{l+m+mi}{230}\PYG{o}{/}\PYG{n}{s}\PYG{p}{,}\PYG{l+m+mi}{230}\PYG{o}{/}\PYG{n}{s}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+m+mi}{255}\PYG{o}{/}\PYG{n}{s}\PYG{p}{,}\PYG{l+m+mi}{176}\PYG{o}{/}\PYG{n}{s}\PYG{p}{,}\PYG{l+m+mi}{159}\PYG{o}{/}\PYG{n}{s}\PYG{p}{]}\PYG{p}{,}
        \PYG{p}{[}\PYG{l+m+mf}{0.0}\PYG{o}{/}\PYG{n}{s}\PYG{p}{,}\PYG{l+m+mf}{0.0}\PYG{o}{/}\PYG{n}{s}\PYG{p}{,}\PYG{l+m+mf}{0.0}\PYG{o}{/}\PYG{n}{s}\PYG{p}{]}\PYG{p}{]}
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{img}\PYG{o}{=}\PYG{n}{np}\PYG{o}{.}\PYG{n}{load}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{data/morphimage.npy}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{dimg}\PYG{o}{=}\PYG{n}{morph}\PYG{o}{.}\PYG{n}{dilation}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{eimg}\PYG{o}{=}\PYG{n}{morph}\PYG{o}{.}\PYG{n}{erosion}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,} \PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{eimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Erosion}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,}  \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}  \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{dimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dilation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_81_0}.png}


\subparagraph{Dilation}
\label{\detokenize{04-BasicSegmentation_Part2:dilation}}
\sphinxAtStartPar
We can use dilation to expand objects, for example a too\sphinxhyphen{}low threshold value leading to disconnected components

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{dimg}\PYG{o}{=}\PYG{n}{morph}\PYG{o}{.}\PYG{n}{dilation}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{o}{+}\PYG{n}{dimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} 
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.55}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)} 
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Operation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{dimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dilated result}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_83_0}.png}


\subparagraph{Erosion}
\label{\detokenize{04-BasicSegmentation_Part2:erosion}}
\sphinxAtStartPar
Erosion performs the opposite task to the dilation by reducing the size of the objects in the image

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{eimg}\PYG{o}{=}\PYG{n}{morph}\PYG{o}{.}\PYG{n}{erosion}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{o}{+}\PYG{n}{eimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} 
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.55}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)} 
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Operation}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{eimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Dilated result}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_85_0}.png}


\paragraph{Opening and Closing}
\label{\detokenize{04-BasicSegmentation_Part2:opening-and-closing}}
\sphinxAtStartPar
Erosion and dilation removes and adds a layer of pixels to the objects in the image.

\sphinxAtStartPar
This is not desired, combining them gives two new operations:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Opening \(\delta(\epsilon(f))\)

\item {} 
\sphinxAtStartPar
Closing \(\epsilon(\delta(f))\)

\end{itemize}

\sphinxAtStartPar
These operation rebuilds most of the objects after removing unwanted features.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{oimg} \PYG{o}{=} \PYG{n}{morph}\PYG{o}{.}\PYG{n}{opening}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
\PYG{n}{cimg} \PYG{o}{=} \PYG{n}{morph}\PYG{o}{.}\PYG{n}{closing}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{np}\PYG{o}{.}\PYG{n}{array}\PYG{p}{(}\PYG{p}{[}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Closing}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{oimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Opening}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{,} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_87_0}.png}


\subparagraph{Morphological Closing}
\label{\detokenize{04-BasicSegmentation_Part2:morphological-closing}}
\sphinxAtStartPar
A dilation followed by an erosion operation
\begin{equation*}
\begin{split}\epsilon(\delta(f))\end{split}
\end{equation*}\begin{itemize}
\item {} 
\sphinxAtStartPar
Adds a layer and then peels a layer off

\item {} 
\sphinxAtStartPar
Objects that are very close are connected when the layer is added and they stay connected when the layer is removed thus the image is \_\_close\_\_d

\item {} 
\sphinxAtStartPar
A cube larger than one voxel will have the exact same volume after (conservative)

\end{itemize}

\sphinxAtStartPar
Closing is an operation you apply to remove false negatives in your image. The effect is that small holes in the objects are filled and gaps between large objects are connected.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original \PYGZdl{}f\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)} \PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{o}{+}\PYG{n}{dimg}\PYG{o}{+}\PYG{n}{cimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Operation \PYGZdl{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{epsilon(}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{delta(f))\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}  \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;} 
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.55}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;} 
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{cimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Closed result}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_90_0}.png}


\subparagraph{Morphological opening}
\label{\detokenize{04-BasicSegmentation_Part2:morphological-opening}}
\sphinxAtStartPar
An erosion followed by a dilation operation
\$\(\delta(\epsilon(f))\)\$
\begin{itemize}
\item {} 
\sphinxAtStartPar
Peels a layer off and adds a layer on

\item {} 
\sphinxAtStartPar
Very small objects and connections are deleted in the erosion and do not return the image is thus \_\_open\_\_ed

\item {} 
\sphinxAtStartPar
A cube larger than several voxels will have the exact same volume after (conservative)

\end{itemize}

\sphinxAtStartPar
Opening is an operation you apply to remove false positives in your image. The effect is that small objects are erased and connections between large objects are removed.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{fig}\PYG{p}{,}\PYG{n}{ax} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,}\PYG{l+m+mi}{3}\PYG{p}{,}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{,}\PYG{l+m+mi}{6}\PYG{p}{]}\PYG{p}{,}\PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{150}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Original \PYGZdl{}f\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{img}\PYG{o}{+}\PYG{n}{eimg}\PYG{o}{+}\PYG{n}{oimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{viridis}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Operation \PYGZdl{}}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{delta(}\PYG{l+s+s1}{\PYGZbs{}}\PYG{l+s+s1}{epsilon(f))\PYGZdl{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.5}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}xticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticks}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{arange}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mf}{0.55}\PYG{p}{,}\PYG{n}{img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}yticklabels}\PYG{p}{(}\PYG{p}{[}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{red}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linestyle}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{linewidth}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{k+kc}{True}\PYG{p}{)}

\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{oimg}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}\PYG{p}{;} \PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Opened result}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}

\PYG{n}{plt}\PYG{o}{.}\PYG{n}{tight\PYGZus{}layout}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_93_0}.png}


\subsubsection{Pitfalls with Segmentation}
\label{\detokenize{04-BasicSegmentation_Part2:pitfalls-with-segmentation}}

\paragraph{Partial Volume Effect}
\label{\detokenize{04-BasicSegmentation_Part2:partial-volume-effect}}\begin{itemize}
\item {} 
\sphinxAtStartPar
The \sphinxhref{http://bit.ly/1mW7kdP}{partial volume effect} is the name for the effect of discretization on the image into pixels or voxels.

\item {} 
\sphinxAtStartPar
Surfaces are complicated, voxels are simple boxes which make poor representations

\item {} 
\sphinxAtStartPar
Many voxels are only partially filled, but only the voxels on the surface

\item {} 
\sphinxAtStartPar
Removing the first layer alleviates issue

\end{itemize}


\paragraph{Thresholding structures}
\label{\detokenize{04-BasicSegmentation_Part2:thresholding-structures}}
\sphinxAtStartPar
What happens when we threshold objects of different sizes?

\sphinxAtStartPar
In this example we create a series of spheres on different grid sizes form 10 up to 500 pixels.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{from} \PYG{n+nn}{scipy}\PYG{n+nn}{.}\PYG{n+nn}{ndimage} \PYG{k+kn}{import} \PYG{n}{zoom}
\PYG{k+kn}{import} \PYG{n+nn}{numpy} \PYG{k}{as} \PYG{n+nn}{np}
\PYG{k+kn}{import} \PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot} \PYG{k}{as} \PYG{n+nn}{plt}
\PYG{k+kn}{from} \PYG{n+nn}{skimage}\PYG{n+nn}{.}\PYG{n+nn}{io} \PYG{k+kn}{import} \PYG{n}{imread}
\PYG{o}{\PYGZpc{}}\PYG{k}{matplotlib} inline
\end{sphinxVerbatim}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{step\PYGZus{}list}  \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{,} \PYG{l+m+mi}{20}\PYG{p}{,} \PYG{l+m+mi}{50}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{,} \PYG{l+m+mi}{500}\PYG{p}{]}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{step\PYGZus{}list}\PYG{p}{)}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{c\PYGZus{}ax}\PYG{p}{,} \PYG{n}{steps} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{m\PYGZus{}axs}\PYG{p}{,} \PYG{n}{step\PYGZus{}list}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{x\PYGZus{}lin}    \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{linspace}\PYG{p}{(}\PYG{o}{\PYGZhy{}}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{steps}\PYG{p}{)}
    \PYG{n}{xy\PYGZus{}area}  \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{diff}\PYG{p}{(}\PYG{n}{x\PYGZus{}lin}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{xx}\PYG{p}{,} \PYG{n}{yy}   \PYG{o}{=} \PYG{n}{np}\PYG{o}{.}\PYG{n}{meshgrid}\PYG{p}{(}\PYG{n}{x\PYGZus{}lin}\PYG{p}{,} \PYG{n}{x\PYGZus{}lin}\PYG{p}{)}
    \PYG{n}{test\PYGZus{}img} \PYG{o}{=} \PYG{p}{(}\PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{xx}\PYG{p}{)}\PYG{o}{+}\PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{n}{yy}\PYG{o}{+}\PYG{l+m+mf}{0.25}\PYG{p}{)}\PYG{p}{)} \PYG{o}{\PYGZlt{}} \PYG{n}{np}\PYG{o}{.}\PYG{n}{square}\PYG{p}{(}\PYG{l+m+mf}{0.75}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{test\PYGZus{}img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{px}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+s1}{Volume Fraction: }\PYG{l+s+si}{\PYGZpc{}2.2f}\PYG{l+s+si}{\PYGZpc{}\PYGZpc{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}}
                   \PYG{p}{(}\PYG{n}{steps}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{test\PYGZus{}img}\PYG{p}{)}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{prod}\PYG{p}{(}\PYG{n}{test\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_98_0}.png}

\sphinxAtStartPar
Here you can see that the small objects are very pixeled and almost doesn’t resemble a disk. When object size increases we see that the object looks more and more like a round disk. We also see that the volume fraction increases towards the value the resembles the volume of a true disc.


\paragraph{When is a sphere really a sphere?}
\label{\detokenize{04-BasicSegmentation_Part2:when-is-a-sphere-really-a-sphere}}
\sphinxAtStartPar
We just saw that a 2D disc can be very pixelated for small radii. The same applies in 3D. In this example, you can see what a sphere looks like. The first two examples doesn’t really look like a sphere, while the last one starts to look like a sphere. The plot in the last panel shows the volume error for different discrete spheres. At a raduis of about 10 pixels the error is below one percent.

\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics[scale=1.0]{{sphere_comparison}.pdf}
\caption{Discrete spheres with increasing radius.}\label{\detokenize{04-BasicSegmentation_Part2:id5}}\end{figure}



\sphinxAtStartPar
What we are learning from this study is that there is a difference between detecting a basic feature and really representing it true shape. Detection should in principle be posible withing a few pixels if the SNR is sufficiently high.


\paragraph{Rescaling}
\label{\detokenize{04-BasicSegmentation_Part2:rescaling}}
\sphinxAtStartPar
Sometimes, we want to downscale the image when it is too large. This is mostly done due to problems of fitting the images into memory or to speed up the processing. Rescaling should generally be done on gray scale images to avoid visible partial volume effects, which means that pixels done have only two values anymore at the edges.

\sphinxAtStartPar
In this example we rescale images from 500x500 down to 15x15 that the apparent volume fraction changes at the edges in some positions.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{zoom\PYGZus{}level} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mf}{0.067}\PYG{p}{,} \PYG{l+m+mf}{0.039}\PYG{p}{,} \PYG{l+m+mf}{0.029}\PYG{p}{,} \PYG{l+m+mf}{0.02}\PYG{p}{]}
\PYG{n}{fig}\PYG{p}{,} \PYG{n}{m\PYGZus{}axs} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{subplots}\PYG{p}{(}\PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{zoom\PYGZus{}level}\PYG{p}{)}\PYG{p}{,} \PYG{n}{figsize}\PYG{o}{=}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dpi}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{)}
\PYG{k}{for} \PYG{p}{(}\PYG{n}{c\PYGZus{}ax}\PYG{p}{,} \PYG{n}{ax2}\PYG{p}{)}\PYG{p}{,} \PYG{n}{c\PYGZus{}zoom} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{m\PYGZus{}axs}\PYG{o}{.}\PYG{n}{T}\PYG{p}{,} \PYG{n}{zoom\PYGZus{}level}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{c\PYGZus{}img} \PYG{o}{=} \PYG{n}{zoom}\PYG{p}{(}\PYG{l+m+mf}{255.0}\PYG{o}{*}\PYG{n}{test\PYGZus{}img}\PYG{p}{,} \PYG{n}{c\PYGZus{}zoom}\PYG{p}{,} \PYG{n}{order}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{imshow}\PYG{p}{(}\PYG{n}{c\PYGZus{}img}\PYG{p}{,}\PYG{n}{cmap}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{gray}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+s1}{px \PYGZhy{} Volume: }\PYG{l+s+si}{\PYGZpc{}2.2f}\PYG{l+s+si}{\PYGZpc{}\PYGZpc{}}\PYG{l+s+s1}{\PYGZsq{}} \PYG{o}{\PYGZpc{}}
                   \PYG{p}{(}\PYG{n}{c\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{o}{*}\PYG{n}{np}\PYG{o}{.}\PYG{n}{sum}\PYG{p}{(}\PYG{n}{c\PYGZus{}img} \PYG{o}{\PYGZgt{}} \PYG{l+m+mf}{0.5}\PYG{p}{)}\PYG{o}{/}\PYG{n}{np}\PYG{o}{.}\PYG{n}{prod}\PYG{p}{(}\PYG{n}{c\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{c\PYGZus{}ax}\PYG{o}{.}\PYG{n}{axis}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{off}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
    \PYG{n}{ax2}\PYG{o}{.}\PYG{n}{plot}\PYG{p}{(}\PYG{n}{c\PYGZus{}img}\PYG{p}{[}\PYG{n}{c\PYGZus{}img}\PYG{o}{.}\PYG{n}{shape}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{/}\PYG{o}{/}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{o\PYGZhy{}}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{n}{color}\PYG{o}{=}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{cornflowerblue}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{04-BasicSegmentation_Part2_106_0}.png}

\sphinxAtStartPar
The intermediate values are in particular visible in the profiles from down sizing from 500 pixel to 20 and 34 pixels.


\subsubsection{Summary}
\label{\detokenize{04-BasicSegmentation_Part2:summary}}
\sphinxAtStartPar
In todays lecture we have looked into
\begin{itemize}
\item {} 
\sphinxAtStartPar
The image formation process and how it relates to the segmentation problem.

\item {} 
\sphinxAtStartPar
How the histogram can be used to decide how to segment an image.

\item {} 
\sphinxAtStartPar
Evaluation of segmentation performance.

\item {} 
\sphinxAtStartPar
The basic operations of morphological image processing
\begin{itemize}
\item {} 
\sphinxAtStartPar
Using morphological operations to clean up segmented images

\end{itemize}

\item {} 
\sphinxAtStartPar
Pitfall with segmentation \sphinxhyphen{} partial volume effects.

\end{itemize}







\renewcommand{\indexname}{Index}
\printindex
\end{document}